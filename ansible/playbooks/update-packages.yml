---
- name: íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° ê´€ë¦¬
  hosts: all_macs
  gather_facts: yes
  tasks:
    - name: ì—…ë°ì´íŠ¸ ì‹œì‘ ë©”ì‹œì§€
      debug:
        msg: |
          ==========================================
          {{ inventory_hostname }} íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ì‹œì‘
          í˜„ì¬ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ==========================================

    - name: í˜„ì¬ ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ë²„ì „ ë°±ì—…
      shell: /opt/homebrew/bin/brew list --versions
      register: packages_before
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"

    - name: ansible ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
      file:
        path: "{{ ansible_env.HOME }}/ansible"
        state: directory
        mode: '0755'

    - name: ë°±ì—… íŒŒì¼ ì €ì¥
      copy:
        content: "{{ packages_before.stdout }}"
        dest: "{{ ansible_env.HOME }}/ansible/package-versions-before-{{ ansible_date_time.date }}.txt"
        mode: '0644'

    - name: Homebrew ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
      shell: |
        export HOMEBREW_NO_AUTO_UPDATE=1
        export HOMEBREW_CURLRC=1
        /opt/homebrew/bin/brew update
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      register: brew_update_result
      ignore_errors: yes

    - name: ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ í™•ì¸
      shell: /opt/homebrew/bin/brew outdated
      register: outdated_packages
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      ignore_errors: yes

    - name: ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ ëª©ë¡ ì¶œë ¥
      debug:
        msg: |
          ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€:
          {{ outdated_packages.stdout_lines | default(['ì—†ìŒ']) }}

    # Docker ì‹¤í–‰ ìƒíƒœ ë¯¸ë¦¬ í™•ì¸ (docker_servers ê·¸ë£¹ì—ì„œë§Œ)
    - name: Docker ì‹¤í–‰ ìƒíƒœ í™•ì¸ (docker_serversë§Œ)
      shell: pgrep -f "Docker Desktop"
      register: docker_running_check
      ignore_errors: yes
      failed_when: false
      when: inventory_hostname in groups['docker_servers']

    - name: Dockerê°€ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš° ì—…ë°ì´íŠ¸ ê±´ë„ˆë›°ê¸° ì•ˆë‚´
      debug:
        msg: |
          âš ï¸  Docker Desktopì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!
          ì•ˆì „ì„ ìœ„í•´ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.
          
          Dockerë¥¼ ì •ì§€í•œ í›„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”:
          1. Docker Desktop ì¢…ë£Œ
          2. ansible-playbook -i inventory.ini update-packages.yml ì¬ì‹¤í–‰
      when: 
        - inventory_hostname in groups['docker_servers']
        - docker_running_check.rc == 0
        - outdated_packages.stdout != ""

    - name: íŒ¨í‚¤ì§€ ì—…ê·¸ë ˆì´ë“œ ì‹¤í–‰
      shell: |
        export HOMEBREW_NO_AUTO_UPDATE=1
        export HOMEBREW_CURLRC=1
        /opt/homebrew/bin/brew upgrade
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      register: brew_upgrade_result
      ignore_errors: yes
      when: 
        - outdated_packages.stdout != ""
        - not (inventory_hostname in groups['docker_servers'] and docker_running_check.rc == 0)

    - name: ì—…ê·¸ë ˆì´ë“œ ê±´ë„ˆë›°ê¸° ë©”ì‹œì§€
      debug:
        msg: "ì—…ê·¸ë ˆì´ë“œí•  íŒ¨í‚¤ì§€ê°€ ì—†ìŠµë‹ˆë‹¤."
      when: outdated_packages.stdout == ""

    # neofetch ì •ë¦¬ ì‘ì—… ì¶”ê°€
    - name: deprecated neofetch í™•ì¸ ë° ì •ë¦¬
      shell: /opt/homebrew/bin/brew list | grep neofetch
      register: neofetch_check
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      ignore_errors: yes
      failed_when: false

    - name: neofetch ì œê±° (deprecated)
      shell: /opt/homebrew/bin/brew uninstall neofetch
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      when: neofetch_check.rc == 0
      ignore_errors: yes

    - name: fastfetch ì„¤ì¹˜ (neofetch ëŒ€ì²´)
      shell: |
        export HOMEBREW_NO_AUTO_UPDATE=1
        export HOMEBREW_CURLRC=1
        /opt/homebrew/bin/brew install fastfetch
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      when: neofetch_check.rc == 0
      ignore_errors: yes

    - name: ë¶ˆí•„ìš”í•œ íŒ¨í‚¤ì§€ ì •ë¦¬
      shell: |
        export HOMEBREW_NO_AUTO_UPDATE=1
        /opt/homebrew/bin/brew cleanup --prune=all
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      register: brew_cleanup_result
      ignore_errors: yes

    - name: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì˜ì¡´ì„± ìë™ ì œê±°
      shell: |
        export HOMEBREW_NO_AUTO_UPDATE=1
        /opt/homebrew/bin/brew autoremove
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      register: brew_autoremove_result
      ignore_errors: yes

    - name: Homebrew ìƒíƒœ ì ê²€
      shell: /opt/homebrew/bin/brew doctor
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      register: brew_doctor_result
      ignore_errors: yes
      failed_when: false  # doctor ê²½ê³ ëŠ” ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ

    - name: ì—…ë°ì´íŠ¸ í›„ íŒ¨í‚¤ì§€ ë²„ì „ í™•ì¸
      shell: /opt/homebrew/bin/brew list --versions
      register: packages_after
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"

    - name: ì—…ë°ì´íŠ¸ í›„ ë²„ì „ íŒŒì¼ ì €ì¥
      copy:
        content: "{{ packages_after.stdout }}"
        dest: "{{ ansible_env.HOME }}/ansible/package-versions-after-{{ ansible_date_time.date }}.txt"
        mode: '0644'

    - name: ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
      shell: df -h {{ ansible_env.HOME }}
      register: disk_usage

    - name: ì‹œìŠ¤í…œ ìƒíƒœ ì •ë³´ ìˆ˜ì§‘
      block:
        - name: ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
          shell: |
            vm_stat | head -10
            echo "---"
            top -l 1 -s 0 | grep "PhysMem"
          register: memory_usage

        - name: CPU ì‚¬ìš©ë¥  í™•ì¸
          shell: top -l 1 -s 0 | grep "CPU usage"
          register: cpu_usage

        - name: ì‹œìŠ¤í…œ ì—…íƒ€ì„ í™•ì¸
          shell: uptime
          register: system_uptime

        - name: ë””ìŠ¤í¬ ì „ì²´ ì‚¬ìš©ëŸ‰ í™•ì¸
          shell: df -h | grep -E "(/System/Volumes/Data|/System/Volumes/VM|disk)"
          register: disk_full_usage

        - name: ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ìƒíƒœ
          shell: ifconfig | grep -E "(en[0-9]|lo[0-9])" -A 1
          register: network_status

        - name: ì‹œìŠ¤í…œ ì˜¨ë„ ë° ì „ë ¥ ì •ë³´ í™•ì¸
          shell: |
            # ì‹œìŠ¤í…œ ì •ë³´ ìˆ˜ì§‘
            echo "=== ì‹œìŠ¤í…œ ì •ë³´ ==="
            system_profiler SPHardwareDataType | grep -E "(Chip|Processor|Memory)" | head -3
            
            echo ""
            echo "=== ì „ë ¥ ê´€ë¦¬ ==="
            pmset -g therm 2>/dev/null || echo "ì—´ ê´€ë¦¬ ì •ë³´ ì—†ìŒ"
            
            echo ""
            echo "=== ë°°í„°ë¦¬ ìƒíƒœ ==="
            pmset -g batt 2>/dev/null || echo "ë°°í„°ë¦¬ ì •ë³´ ì—†ìŒ"
            
            echo ""
            echo "=== ì‹œìŠ¤í…œ ë¶€í•˜ ==="
            sysctl machdep.cpu.thermal_state 2>/dev/null || echo "ì˜¨ë„ ì„¼ì„œ ì ‘ê·¼ ë¶ˆê°€"
          register: system_temp
          ignore_errors: yes

        - name: Homebrew íŒ¨í‚¤ì§€ í†µê³„
          shell: |
            echo "ì „ì²´ ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€: $(/opt/homebrew/bin/brew list --formula | wc -l | xargs)"
            echo "Cask ì• í”Œë¦¬ì¼€ì´ì…˜: $(/opt/homebrew/bin/brew list --cask | wc -l | xargs)"
            echo "ì„œë¹„ìŠ¤ ì‹¤í–‰ ì¤‘: $(/opt/homebrew/bin/brew services list | grep started | wc -l | xargs)"
          environment:
            PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
          register: brew_stats

    - name: ì‹¤í–‰ ë¡œê·¸ ì €ì¥
      copy:
        content: |
          ==========================================
          {{ inventory_hostname }} ì—…ë°ì´íŠ¸ ë¡œê·¸
          ì‹¤í–‰ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ==========================================
          
          ğŸ“¦ ì—…ë°ì´íŠ¸ ê°€ëŠ¥í–ˆë˜ íŒ¨í‚¤ì§€: {{ outdated_packages.stdout_lines | length | default(0) }}ê°œ
          {% if outdated_packages.stdout_lines | length > 0 %}
          ì—…ë°ì´íŠ¸ëœ íŒ¨í‚¤ì§€ ëª©ë¡:
          {{ outdated_packages.stdout }}
          {% endif %}
          
          ğŸ—‘ï¸ ì •ë¦¬ëœ ìºì‹œ: {{ brew_cleanup_result.stdout_lines | length | default(0) }}ê°œ í•­ëª©
          
          ğŸ§¹ ìë™ ì œê±°ëœ ì˜ì¡´ì„±: {{ brew_autoremove_result.stdout_lines | length | default(0) }}ê°œ íŒ¨í‚¤ì§€
          
          ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: {{ disk_usage.stdout.split() | last }}
          
          âš ï¸ Homebrew Doctor ê²°ê³¼:
          {{ brew_doctor_result.stdout | default('ì •ìƒ') }}
          
          
          ğŸ–¥ï¸ ì‹œìŠ¤í…œ ìƒíƒœ:
          {{ system_uptime.stdout }}
          {{ cpu_usage.stdout }}
          {{ memory_usage.stdout_lines[11] | default('ë©”ëª¨ë¦¬ ì •ë³´ ì—†ìŒ') }}
          
          ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:
          {{ disk_full_usage.stdout }}
          
          ğŸ“¦ Homebrew í†µê³„:
          {{ brew_stats.stdout }}
          
          ğŸŒ¡ï¸ ì‹œìŠ¤í…œ & ì „ë ¥ ì •ë³´:
          {{ system_temp.stdout | default('í™•ì¸ ë¶ˆê°€') }}
          
          âš ï¸ Homebrew Doctor ê²°ê³¼:
          {{ brew_doctor_result.stdout | default('ì •ìƒ') }}
          
          ğŸ“„ ë°±ì—… íŒŒì¼:
          - ì—…ë°ì´íŠ¸ ì „: ~/ansible/package-versions-before-{{ ansible_date_time.date }}.txt
          - ì—…ë°ì´íŠ¸ í›„: ~/ansible/package-versions-after-{{ ansible_date_time.date }}.txt
          
          ğŸ“Š ìƒì„¸ ë¡œê·¸: ~/ansible/update-log-{{ ansible_date_time.date }}-{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}.txt
          
          ==========================================
          ì‹¤í–‰ ì™„ë£Œ: {{ ansible_date_time.iso8601 }}
          ==========================================
        dest: "{{ ansible_env.HOME }}/ansible/update-log-{{ ansible_date_time.date }}-{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}.txt"
        mode: '0644'

    - name: ì—…ë°ì´íŠ¸ ì™„ë£Œ ë¦¬í¬íŠ¸
      debug:
        msg: |
          ==========================================
          {{ inventory_hostname }} ì—…ë°ì´íŠ¸ ì™„ë£Œ!
          
          ğŸ“¦ ì—…ë°ì´íŠ¸ ê°€ëŠ¥í–ˆë˜ íŒ¨í‚¤ì§€: {{ outdated_packages.stdout_lines | length | default(0) }}ê°œ
          ğŸ—‘ï¸  ì •ë¦¬ëœ ìºì‹œ: {{ brew_cleanup_result.stdout_lines | length | default(0) }}ê°œ í•­ëª©
          
          ğŸ§¹ ìë™ ì œê±°ëœ ì˜ì¡´ì„±: {{ brew_autoremove_result.stdout_lines | length | default(0) }}ê°œ íŒ¨í‚¤ì§€
          
          ğŸ–¥ï¸  ì‹œìŠ¤í…œ ìƒíƒœ:
          {{ system_uptime.stdout }}
          {{ cpu_usage.stdout }}
          {{ memory_usage.stdout_lines[11] | default('ë©”ëª¨ë¦¬ ì •ë³´ ì—†ìŒ') }}
          
          ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:
          {{ disk_full_usage.stdout }}
          
          ğŸ“¦ Homebrew í†µê³„:
          {{ brew_stats.stdout }}
          
          ğŸŒ¡ï¸  ì‹œìŠ¤í…œ ì˜¨ë„: {{ system_temp.stdout | default('í™•ì¸ ë¶ˆê°€') }}
          
          âš ï¸  Homebrew Doctor ê²°ê³¼:
          {{ brew_doctor_result.stdout | default('ì •ìƒ') }}
          
          ğŸ“„ ë°±ì—… íŒŒì¼:
          - ì—…ë°ì´íŠ¸ ì „: ~/ansible/package-versions-before-{{ ansible_date_time.date }}.txt
          - ì—…ë°ì´íŠ¸ í›„: ~/ansible/package-versions-after-{{ ansible_date_time.date }}.txt
          ==========================================

- name: ì„œë¹„ìŠ¤ ì¬ì‹œì‘ í™•ì¸ (ì„ íƒì )
  hosts: all_macs
  tasks:
    - name: Jenkins ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
      shell: /opt/homebrew/bin/brew services list | grep jenkins
      register: jenkins_status
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"

    - name: Jenkins ì¬ì‹œì‘ ì•ˆë‚´
      debug:
        msg: |
          Jenkins ìƒíƒœ: {{ jenkins_status.stdout }}
          
          ğŸ’¡ Jenkinsê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆë‹¤ë©´ ìˆ˜ë™ ì¬ì‹œì‘ì„ ê¶Œì¥í•©ë‹ˆë‹¤:
          ansible {{ inventory_hostname }} -a "brew services restart jenkins-lts"
      when: "'jenkins' in outdated_packages.stdout | default('')"

- name: Docker ì„œë²„ ì „ìš© ì‘ì—… (ì•ˆì „í•œ ì²˜ë¦¬)
  hosts: docker_servers
  tasks:
    - name: Docker ì„¤ì¹˜ í™•ì¸
      shell: which docker
      register: docker_exists
      ignore_errors: yes
      failed_when: false

    - name: Docker ë²„ì „ í™•ì¸ (Dockerê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ)
      shell: docker --version
      register: docker_version
      ignore_errors: yes
      failed_when: false
      when: docker_exists.rc == 0

    - name: Docker Desktop ì‹¤í–‰ ìƒíƒœ í™•ì¸
      shell: pgrep -f "Docker Desktop"
      register: docker_desktop_running
      ignore_errors: yes
      failed_when: false
      when: docker_exists.rc == 0

    - name: Docker ìƒíƒœ ë¦¬í¬íŠ¸
      debug:
        msg: |
          ğŸ³ Docker ìƒíƒœ ë¦¬í¬íŠ¸:
          - Docker ëª…ë ¹ì–´: {{ 'available' if docker_exists.rc == 0 else 'not found' }}
          {% if docker_exists.rc == 0 %}
          - Docker ë²„ì „: {{ docker_version.stdout | default('í™•ì¸ ì‹¤íŒ¨') }}
          - Docker Desktop: {{ 'running' if docker_desktop_running.rc == 0 else 'not running' }}
          {% else %}
          
          ğŸ’¡ Docker ì„¤ì¹˜ ê¶Œì¥ì‚¬í•­:
          1. Docker Desktop ì„¤ì¹˜: brew install --cask docker
          2. Applicationsì—ì„œ Docker Desktop ì‹¤í–‰
          3. Docker Desktopì´ ì™„ì „íˆ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          {% endif %}

    - name: Docker ì—…ë°ì´íŠ¸ ì•ˆë‚´ (Dockerê°€ ìˆê³  ì—…ë°ì´íŠ¸ëœ ê²½ìš°)
      debug:
        msg: |
          ğŸ”„ Dockerê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!
          
          ê¶Œì¥ ì‘ì—…:
          1. Docker Desktop ì¬ì‹œì‘
          2. ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸: docker ps
          3. í•„ìš”ì‹œ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘: docker restart <container_name>
      when: 
        - docker_exists.rc == 0
        - "'docker' in outdated_packages.stdout | default('')"