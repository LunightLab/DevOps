---
- name: GitLab Docker Compose ì„¤ì¹˜ ë° ì„¤ì • (Jenkins ì—°ë™ ìµœì í™”)
  hosts: docker_servers
  gather_facts: yes
  vars:
    gitlab_base_dir: "/opt/gitlab"
    docker_compose_dir: "/opt/gitlab-docker"
    # 2025ë…„ 1ì›” ê¸°ì¤€ ê¶Œì¥ ë²„ì „
    gitlab_version: "18.1.1-ce.0"  # ìµœì‹  ì•ˆì • ë²„ì „

  tasks:
    - name: ansible ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
      file:
        path: "{{ ansible_env.HOME }}/ansible"
        state: directory
        mode: '0755'

    - name: GitLab ë””ë ‰í† ë¦¬ ìƒì„±
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
      loop:
        - "{{ gitlab_base_dir }}/config"
        - "{{ gitlab_base_dir }}/logs"
        - "{{ gitlab_base_dir }}/data"
        - "{{ docker_compose_dir }}"
      become: yes

    - name: Docker ì„¤ì¹˜ í™•ì¸
      shell: which docker
      register: docker_exists
      ignore_errors: yes
      failed_when: false

    - name: Docker ì„¤ì¹˜ (í•„ìš”í•œ ê²½ìš°)
      shell: |
        echo "ğŸ³ Docker ì„¤ì¹˜ ì‹œì‘..."
        /opt/homebrew/bin/brew install --cask docker
        echo "âœ… Docker ì„¤ì¹˜ ì™„ë£Œ"
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      when: docker_exists.rc != 0
      register: docker_install

    - name: Docker Desktop ì‹œì‘ ì•ˆë‚´
      debug:
        msg: |
          âš ï¸ Docker Desktopì„ ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤!
          
          1. Applications í´ë”ì—ì„œ Docker ì•±ì„ ì‹¤í–‰í•˜ì„¸ìš”
          2. Docker Desktopì´ ì™„ì „íˆ ì‹œì‘ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì„¸ìš” (2-3ë¶„)
          3. í„°ë¯¸ë„ì—ì„œ 'docker ps' ëª…ë ¹ì–´ê°€ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”
          
          Docker Desktop ì‹œì‘ í›„ ì´ í”Œë ˆì´ë¶ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.
      when: docker_exists.rc != 0

    - name: Docker ì‹¤í–‰ ìƒíƒœ í™•ì¸ (ì—¬ëŸ¬ ê²½ë¡œ ì‹œë„)
      shell: |
        if command -v /opt/homebrew/bin/docker >/dev/null 2>&1; then
          echo "homebrew_docker"
          /opt/homebrew/bin/docker ps
        elif command -v /Applications/Docker.app/Contents/Resources/bin/docker >/dev/null 2>&1; then
          echo "desktop_docker"
          /Applications/Docker.app/Contents/Resources/bin/docker ps
        elif command -v docker >/dev/null 2>&1; then
          echo "system_docker"
          docker ps
        else
          echo "no_docker"
          exit 1
        fi
      register: docker_running_check
      ignore_errors: yes
      failed_when: false

    - name: Docker ëª…ë ¹ì–´ ê²½ë¡œ ì„¤ì •
      set_fact:
        docker_cmd: >-
          {%- if docker_running_check.stdout_lines[0] == 'homebrew_docker' -%}
          /opt/homebrew/bin/docker
          {%- elif docker_running_check.stdout_lines[0] == 'desktop_docker' -%}
          /Applications/Docker.app/Contents/Resources/bin/docker
          {%- elif docker_running_check.stdout_lines[0] == 'system_docker' -%}
          docker
          {%- else -%}
          docker
          {%- endif -%}
        docker_running: "{{ docker_running_check }}"

    - name: Docker Desktop ì‹œì‘ ì•ˆë‚´ (Dockerê°€ ì—†ëŠ” ê²½ìš°)
      debug:
        msg: |
          âš ï¸ Dockerê°€ ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!
          
          í•´ê²° ë°©ë²•:
          1. Docker Desktop ì•±ì„ ì‹œì‘í•˜ì„¸ìš”: open -a Docker
          2. ì™„ì „íˆ ë¡œë”©ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì„¸ìš” (2-3ë¶„)
          3. ë‹¤ì‹œ í”Œë ˆì´ë¶ì„ ì‹¤í–‰í•˜ì„¸ìš”
          
          í™•ì¸ ëª…ë ¹ì–´: ansible mac-studio-docker -a "docker ps"
          
          â¸ï¸ GitLab ì„¤ì¹˜ë¥¼ ì¼ì‹œ ì¤‘ì§€í•©ë‹ˆë‹¤.
      when: docker_running.rc != 0

    - name: GitLab ì„¤ì¹˜ ê³„ì† ì§„í–‰
      debug:
        msg: "âœ… Dockerê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. GitLab ì„¤ì¹˜ë¥¼ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤. (Docker ê²½ë¡œ: {{ docker_cmd }})"
      when: docker_running.rc == 0

    - name: Docker Compose íŒŒì¼ ìƒì„± (Jenkins ì—°ë™ ìµœì í™” - Docker ë³¼ë¥¨ ì‚¬ìš©)
      when: docker_running.rc == 0
      copy:
        content: |
          # GitLab {{ gitlab_version }} - Jenkins ì—°ë™ ìµœì í™” (Docker ê´€ë¦¬ ë³¼ë¥¨)
          services:
            gitlab:
              image: gitlab/gitlab-ce:{{ gitlab_version }}
              hostname: 'gitlab.local'
              container_name: gitlab
              restart: always
              
              ports:
                - '80:80'      # HTTP
                - '443:443'    # HTTPS  
                - '2222:22'    # SSH (í˜¸ìŠ¤íŠ¸ 22ë²ˆê³¼ ì¶©ëŒ ë°©ì§€)
              
              volumes:
                - gitlab_config:/etc/gitlab
                - gitlab_logs:/var/log/gitlab
                - gitlab_data:/var/opt/gitlab
              
              environment:
                GITLAB_OMNIBUS_CONFIG: |
                  # ì™¸ë¶€ URL ì„¤ì •
                  external_url 'http://gitlab.local'
                  
                  # SSH í¬íŠ¸ ë³€ê²½
                  gitlab_rails['gitlab_shell_ssh_port'] = 2222
                  
                  # === Jenkins ì—°ë™ ìµœì í™” ===
                  # GitLab CI/CD ì™„ì „ ë¹„í™œì„±í™” (Jenkins ì‚¬ìš©)
                  gitlab_rails['auto_devops_enabled'] = false
                  gitlab_rails['gitlab_default_can_create_group'] = true
                  
                  # Webhook ë° Integration í™œì„±í™” (Jenkins ì—°ë™ìš©)
                  gitlab_rails['webhook_timeout'] = 30
                  gitlab_rails['gitlab_default_projects_limit'] = 100
                  
                  # === ë©”ëª¨ë¦¬ ìµœì í™” (CI ë¹„í™œì„±í™”ë¡œ ë” íš¨ìœ¨ì ) ===
                  # Puma ì›Œì»¤ ìˆ˜ (CI ì—†ìœ¼ë‹ˆ ì ê²Œ)
                  puma['worker_processes'] = 2
                  puma['max_threads'] = 6
                  puma['min_threads'] = 2
                  
                  # Sidekiq ë™ì‹œ ì‹¤í–‰ ìˆ˜ ì¤„ì´ê¸° (CI ì‘ì—… ì—†ìŒ)
                  sidekiq['max_concurrency'] = 15
                  
                  # === ë¶ˆí•„ìš”í•œ ê¸°ëŠ¥ ë¹„í™œì„±í™” ===
                  # GitLab Pages ë¹„í™œì„±í™”
                  gitlab_pages['enable'] = false
                  
                  # Container Registry ë¹„í™œì„±í™” (Jenkinsì—ì„œ Docker Hub ì‚¬ìš©)
                  registry['enable'] = false
                  
                  # GitLab CI/CD ê´€ë ¨ ê¸°ëŠ¥ ë¹„í™œì„±í™”
                  gitlab_ci['gitlab_ci_all_broken_builds'] = false
                  gitlab_rails['artifacts_enabled'] = false
                  gitlab_rails['lfs_enabled'] = false
                  
                  # Monitoring ë¹„í™œì„±í™” (GitLab 18.x í˜¸í™˜)
                  prometheus_monitoring['enable'] = false
                  # grafana, alertmanager ë“±ì€ 18.xì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŒ
                  
                  # === Jenkins ì—°ë™ì„ ìœ„í•œ API ì„¤ì • ===
                  # API rate limit ì™„í™” (Jenkins webhookìš©)
                  gitlab_rails['rack_attack_git_basic_auth'] = {
                    'enabled' => false
                  }
                  
                  # === ìš©ëŸ‰ ê´€ë¦¬ ì„¤ì • ===
                  # ë¡œê·¸ ë³´ê´€ ê¸°ê°„ ë‹¨ì¶• (CI ë¡œê·¸ ì—†ìœ¼ë‹ˆê¹Œ)
                  logging['log_level'] = 'INFO'
                  logging['logrotate_frequency'] = "daily"
                  logging['logrotate_rotate'] = 5
                  logging['logrotate_size'] = "50M"
                  
                  # ë°±ì—… ë³´ê´€ ê¸°ê°„
                  gitlab_rails['backup_keep_time'] = 604800  # 7ì¼
                  
                  # === ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™” (ë©”ëª¨ë¦¬ ë„‰ë„‰í•˜ê²Œ í™œìš©) ===
                  postgresql['shared_buffers'] = "2GB"
                  postgresql['effective_cache_size'] = "8GB"
                  postgresql['work_mem'] = "64MB"
                  postgresql['maintenance_work_mem'] = "512MB"
                  postgresql['max_connections'] = 200
                  
                  # === ì´ë©”ì¼ ì„¤ì • (Jenkins ì•Œë¦¼ ì‚¬ìš©ì‹œ) ===
                  gitlab_rails['smtp_enable'] = false  # í•„ìš”ì‹œ trueë¡œ ë³€ê²½
                  
                  # === Git ìµœì í™” ===
                  # Git ì„±ëŠ¥ í–¥ìƒ (Jenkinsì—ì„œ clone ë§ì´ í•  ë•Œ)
                  gitlab_rails['gitlab_shell_git_timeout'] = 300
                  gitaly['git_catfile_cache_size'] = 100
              
              # ë©”ëª¨ë¦¬ ì œí•œ ì„¤ì • (M4 Max 36GB ê¸°ì¤€ - ë„‰ë„‰í•˜ê²Œ)
              deploy:
                resources:
                  limits:
                    memory: 16G      # ì›ë˜ëŒ€ë¡œ 16GB (ì—¬ìœ ë¡­ê²Œ)
                    cpus: '8'        # CPUë„ ì¶©ë¶„íˆ í™œìš©
                  reservations:
                    memory: 8G       # ìµœì†Œ 8GB ë³´ì¥
                    cpus: '4'
              
              # ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost/-/health"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 120s

          # Docker ê´€ë¦¬ ë³¼ë¥¨ (ê¶Œí•œ ë¬¸ì œ ì—†ìŒ)
          volumes:
            gitlab_config:
              name: gitlab_config
            gitlab_logs:
              name: gitlab_logs  
            gitlab_data:
              name: gitlab_data

          networks:
            default:
              name: gitlab-network
        dest: "{{ docker_compose_dir }}/docker-compose.yml"
        mode: '0644'

    - name: Jenkins ì—°ë™ ê°€ì´ë“œ ìƒì„±
      copy:
        content: |
          #!/bin/bash
          # GitLab + Jenkins ì—°ë™ ê°€ì´ë“œ
          
          echo "========================================"
          echo "GitLab + Jenkins ì—°ë™ ì„¤ì • ê°€ì´ë“œ"
          echo "========================================"
          echo ""
          echo "ğŸ”— 1. GitLabì—ì„œ Jenkins Webhook ì„¤ì •:"
          echo "   - GitLab í”„ë¡œì íŠ¸ > Settings > Webhooks"
          echo "   - URL: http://jenkins-server:8081/gitlab/notify"
          echo "   - Trigger: Push events, Merge request events"
          echo ""
          echo "ğŸ”‘ 2. GitLab Personal Access Token ìƒì„±:"
          echo "   - GitLab > User Settings > Access Tokens"
          echo "   - Scopes: api, read_repository"
          echo "   - Jenkinsì—ì„œ GitLab ì—°ê²° ì‹œ ì‚¬ìš©"
          echo ""
          echo "ğŸ”§ 3. Jenkins GitLab Plugin ì„¤ì •:"
          echo "   - Jenkins > Manage Jenkins > Configure System"
          echo "   - GitLab sectionì—ì„œ GitLab ì„œë²„ ì¶”ê°€"
          echo "   - Connection name: GitLab"
          echo "   - GitLab host URL: http://gitlab.local"
          echo "   - Credentialsì— Personal Access Token ì¶”ê°€"
          echo ""
          echo "ğŸ“‹ 4. Jenkins Job ì„¤ì •:"
          echo "   - Source Code Management: Git"
          echo "   - Repository URL: http://gitlab.local/group/project.git"
          echo "   - Credentials: GitLab Personal Access Token"
          echo "   - Build Triggers: GitLab webhook"
          echo ""
          echo "âœ… 5. í…ŒìŠ¤íŠ¸:"
          echo "   - GitLabì— ì½”ë“œ push"
          echo "   - Jenkinsì—ì„œ ìë™ ë¹Œë“œ í™•ì¸"
          echo ""
          echo "========================================"
        dest: "{{ docker_compose_dir }}/jenkins-integration-guide.sh"
        mode: '0755'

    - name: GitLab ìš©ëŸ‰ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (Docker ë³¼ë¥¨ ë²„ì „)
      copy:
        content: |
          #!/bin/bash
          # GitLab ìš©ëŸ‰ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ (Docker ë³¼ë¥¨ í™˜ê²½ìš©)
          GITLAB_CONTAINER="gitlab"
          BACKUP_DAYS=7
          LOG_DAYS=3

          echo "==================================="
          echo "GitLab ìš©ëŸ‰ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ (Docker ë³¼ë¥¨)"
          echo "==================================="

          # Docker ë³¼ë¥¨ ìš©ëŸ‰ í™•ì¸
          echo "ğŸ“Š GitLab Docker ë³¼ë¥¨ ìš©ëŸ‰:"
          docker system df -v | grep gitlab || echo "GitLab ë³¼ë¥¨ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

          echo ""
          echo "ğŸ“Š ì „ì²´ Docker ìš©ëŸ‰ ì‚¬ìš©ëŸ‰:"
          docker system df

          # GitLab ë‚´ë¶€ ì •ë¦¬ (CI ê´€ë ¨ ì œì™¸)
          echo ""
          echo "ğŸ§¹ GitLab ë‚´ë¶€ ì •ë¦¬ ì‘ì—…..."
          {{ docker_cmd }} exec $GITLAB_CONTAINER bash -c "
            gitlab-rake tmp:clear
            gitlab-rake gitlab:cleanup:repos
            gitlab-rake gitlab:cleanup:sessions
            gitlab-rake gitlab:cleanup:uploads
            gitlab-rake gitlab:cleanup:orphan_job_artifact_files
          "

          # Docker ì‹œìŠ¤í…œ ì •ë¦¬
          echo ""
          echo "ğŸ³ Docker ì‹œìŠ¤í…œ ì •ë¦¬..."
          {{ docker_cmd }} image prune -f
          {{ docker_cmd }} volume prune -f
          {{ docker_cmd }} network prune -f

          echo ""
          echo "âœ… GitLab ìš©ëŸ‰ ê´€ë¦¬ ì‘ì—… ì™„ë£Œ!"
          echo "ğŸ’¡ Docker ê´€ë¦¬ ë³¼ë¥¨ ì‚¬ìš©ìœ¼ë¡œ ê¶Œí•œ ë¬¸ì œ ì—†ì´ ê´€ë¦¬ë©ë‹ˆë‹¤."
        dest: "{{ docker_compose_dir }}/gitlab-cleanup.sh"
        mode: '0755'

    - name: GitLab ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (ì˜¬ë°”ë¥¸ Docker ê²½ë¡œ ì‚¬ìš©)
      shell: |
        echo "ğŸ³ GitLab ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹œì‘..."
        {{ docker_cmd }} pull gitlab/gitlab-ce:{{ gitlab_version }}
        echo "âœ… GitLab ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
      environment:
        PATH: "/opt/homebrew/bin:/Applications/Docker.app/Contents/Resources/bin:{{ ansible_env.PATH }}"
      register: docker_pull_result
      when: docker_running.rc == 0
      ignore_errors: yes

    - name: GitLab ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ì˜¬ë°”ë¥¸ Docker ê²½ë¡œ ì‚¬ìš©)
      shell: |
        echo "ğŸš€ GitLab ì»¨í…Œì´ë„ˆ ì‹œì‘..."
        cd {{ docker_compose_dir }}
        {{ docker_cmd }} compose up -d
        echo "âœ… GitLab ì»¨í…Œì´ë„ˆ ì‹œì‘ ì™„ë£Œ"
      environment:
        PATH: "/opt/homebrew/bin:/Applications/Docker.app/Contents/Resources/bin:{{ ansible_env.PATH }}"
      register: docker_compose_result
      when: docker_running.rc == 0
      retries: 3
      delay: 10

    - name: GitLab ì‹œì‘ ëŒ€ê¸° (ìµœëŒ€ 10ë¶„, macOS í˜¸í™˜)
      shell: |
        echo "â³ GitLab ì‹œì‘ ëŒ€ê¸° ì¤‘... (ìµœëŒ€ 10ë¶„)"
        for i in {1..60}; do
          if curl -f http://localhost/-/health 2>/dev/null; then
            echo "âœ… GitLabì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ($i/60 ì‹œë„)"
            exit 0
          fi
          echo "â³ ëŒ€ê¸° ì¤‘... ($i/60) - 10ì´ˆ í›„ ì¬ì‹œë„"
          sleep 10
        done
        echo "âš ï¸ 10ë¶„ í›„ì—ë„ GitLabì´ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•´ì£¼ì„¸ìš”."
        exit 1
      register: gitlab_health_check
      ignore_errors: yes
      when: docker_running.rc == 0

    - name: ì´ˆê¸° root íŒ¨ìŠ¤ì›Œë“œ í™•ì¸ (ì˜¬ë°”ë¥¸ Docker ê²½ë¡œ ì‚¬ìš©)
      shell: "{{ docker_cmd }} exec gitlab cat /etc/gitlab/initial_root_password 2>/dev/null || echo 'íŒ¨ìŠ¤ì›Œë“œ íŒŒì¼ ì—†ìŒ'"
      register: root_password
      ignore_errors: yes
      when: docker_running.rc == 0

    - name: GitLab ì„¤ì¹˜ ì™„ë£Œ ë¦¬í¬íŠ¸ (Jenkins ì—°ë™ ë²„ì „)
      debug:
        msg: |
          ==========================================
          ğŸ‰ {{ inventory_hostname }} GitLab ì„¤ì¹˜ {{ 'SUCCESS' if docker_running is defined and docker_running.rc == 0 else 'PENDING' }}!
          ==========================================
          
          ğŸ“¦ GitLab ë²„ì „: {{ gitlab_version }} (Jenkins ì—°ë™ ìµœì í™”)
          
          {% if docker_running is defined and docker_running.rc == 0 %}
          ğŸŒ ì ‘ì† URL:
          - GitLab: http://{{ ansible_host }}
          
          âš ï¸ ìµœì í™”ëœ ì„¤ì • (Jenkins í™˜ê²½):
          âœ… GitLab CI/CD ë¹„í™œì„±í™” (Jenkins ì‚¬ìš©)
          âœ… Container Registry ë¹„í™œì„±í™” (Docker Hub ì‚¬ìš© ê¶Œì¥)
          âœ… GitLab Pages ë¹„í™œì„±í™”
          âœ… Artifacts/LFS ë¹„í™œì„±í™”
          âœ… ë©”ëª¨ë¦¬ ì—¬ìœ ë¡­ê²Œ 16GB í• ë‹¹ (ë¹ ë¥¸ ì„±ëŠ¥)
          âœ… CPU 8ì½”ì–´ í™œìš© (M4 Max ìµœì í™”)
          âœ… ë¶ˆí•„ìš”í•œ ëª¨ë‹ˆí„°ë§ ë¹„í™œì„±í™”
          
          ğŸ‘¤ ì´ˆê¸° ë¡œê·¸ì¸:
          - ì‚¬ìš©ì: root
          - ë¹„ë°€ë²ˆí˜¸: (ì•„ë˜ í™•ì¸)
          
          ğŸ”‘ ì´ˆê¸° root íŒ¨ìŠ¤ì›Œë“œ:
          {% if root_password is defined and root_password.stdout is defined and root_password.stdout %}
          {{ root_password.stdout }}
          {% else %}
          ì•„ì§ ìƒì„±ë˜ì§€ ì•ŠìŒ (GitLab ì‹œì‘ í›„ í™•ì¸):
          docker exec gitlab cat /etc/gitlab/initial_root_password
          {% endif %}
          
          ğŸ”— Jenkins ì—°ë™:
          - ê°€ì´ë“œ: {{ docker_compose_dir }}/jenkins-integration-guide.sh
          - Webhook URL: http://jenkins-server:8081/gitlab/notify
          - SSH í´ë¡ : ssh://git@{{ ansible_host }}:2222/group/project.git
          - HTTP í´ë¡ : http://{{ ansible_host }}/group/project.git
          {% else %}
          â¸ï¸ Dockerê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•„ GitLab ì„¤ì¹˜ë¥¼ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.
          {% endif %}
          
          ğŸ“ ì„¤ì¹˜ ê²½ë¡œ:
          - Docker Compose: {{ docker_compose_dir }}
          - GitLab ë°ì´í„°: Docker ê´€ë¦¬ ë³¼ë¥¨ (gitlab_data)
          - Jenkins ì—°ë™ ê°€ì´ë“œ: {{ docker_compose_dir }}/jenkins-integration-guide.sh
          
          ğŸ› ï¸ ê´€ë¦¬ ëª…ë ¹ì–´:
          - ìƒíƒœ í™•ì¸: cd {{ docker_compose_dir }} && docker compose ps
          - ë¡œê·¸ í™•ì¸: cd {{ docker_compose_dir }} && docker compose logs -f
          - ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸: {{ docker_compose_dir }}/gitlab-cleanup.sh
          
          ğŸ’¡ Jenkins ì—°ë™ í˜œíƒ:
          - GitLab: ì†ŒìŠ¤ ì½”ë“œ ê´€ë¦¬ + ì´ìŠˆ íŠ¸ë˜í‚¹ì— ì§‘ì¤‘
          - Jenkins: CI/CD íŒŒì´í”„ë¼ì¸ ì „ë‹´
          - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëŒ€í­ ì ˆì•½ (16GB â†’ 8GB)
          - ì•ˆì •ì ì¸ ë¶„ë¦¬ëœ ì•„í‚¤í…ì²˜
          ==========================================

    - name: ì„¤ì¹˜ ë¡œê·¸ ì €ì¥
      copy:
        content: |
          GitLab ì„¤ì¹˜ ë¡œê·¸ (Jenkins ì—°ë™ ìµœì í™” ë²„ì „)
          ì„¤ì¹˜ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ì„œë²„: {{ inventory_hostname }}
          GitLab ë²„ì „: {{ gitlab_version }}
          
          === Jenkins ì—°ë™ ìµœì í™” ì„¤ì • ===
          âœ… GitLab CI/CD ë¹„í™œì„±í™”
          âœ… Container Registry ë¹„í™œì„±í™”  
          âœ… GitLab Pages ë¹„í™œì„±í™”
          âœ… Artifacts/LFS ë¹„í™œì„±í™”
          âœ… ë©”ëª¨ë¦¬ 16GB í• ë‹¹ (ì—¬ìœ ë¡œìš´ ì„±ëŠ¥)
          âœ… ë¶ˆí•„ìš”í•œ ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ ë¹„í™œì„±í™”
          
          === ì„¤ì¹˜ ê²½ë¡œ ===
          - Docker Compose: {{ docker_compose_dir }}
          - GitLab ë°ì´í„°: Docker ê´€ë¦¬ ë³¼ë¥¨ (gitlab_data, gitlab_config, gitlab_logs)
          - Jenkins ì—°ë™ ê°€ì´ë“œ: {{ docker_compose_dir }}/jenkins-integration-guide.sh
          
          === ì´ˆê¸° íŒ¨ìŠ¤ì›Œë“œ ===
          {% if root_password is defined and root_password.stdout is defined and root_password.stdout %}
          {{ root_password.stdout }}
          {% else %}
          ì•„ì§ ìƒì„±ë˜ì§€ ì•ŠìŒ
          í™•ì¸ ëª…ë ¹ì–´: {{ docker_cmd }} exec gitlab cat /etc/gitlab/initial_root_password
          {% endif %}
          
          === Jenkins ì—°ë™ URL ===
          {% if docker_running is defined and docker_running.rc == 0 %}
          GitLab URL: http://{{ ansible_host }}
          SSH í´ë¡ : ssh://git@{{ ansible_host }}:2222/group/project.git
          HTTP í´ë¡ : http://{{ ansible_host }}/group/project.git
          Webhook: http://jenkins-server:8081/gitlab/notify
          {% endif %}
          
          === ë‹¤ìŒ ë‹¨ê³„ ===
          1. GitLab ì›¹ UI ì ‘ì† ë° ì´ˆê¸° ì„¤ì •
          2. Jenkins ì—°ë™ ê°€ì´ë“œ ì‹¤í–‰
          3. Personal Access Token ìƒì„±
          4. Jenkinsì—ì„œ GitLab í”ŒëŸ¬ê·¸ì¸ ì„¤ì •
          5. Webhook ì—°ê²° í…ŒìŠ¤íŠ¸
        dest: "{{ ansible_env.HOME }}/ansible/gitlab-jenkins-install-{{ ansible_date_time.date }}.txt"
        mode: '0644'