---
- name: Mac ì„œë²„ ì´ˆê¸° ì„¤ì¹˜
  hosts: all_macs
  gather_facts: yes
  # vars ì„¹ì…˜ ì œê±° - group_vars/all.ymlì—ì„œ ë¡œë“œë¨
      
  tasks:
    - name: í˜„ì¬ ì‹œìŠ¤í…œ ì •ë³´ ì¶œë ¥
      debug:
        msg: |
          === Mac ì„œë²„ ì´ˆê¸° ì„¤ì¹˜ ===
          ì„œë²„: {{ inventory_hostname }}
          ì‚¬ìš©ì: {{ ansible_user }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ì•„í‚¤í…ì²˜: {{ ansible_architecture }}

    - name: Homebrew ì„¤ì¹˜ í™•ì¸ (ê²½ë¡œ í¬í•¨)
      shell: ls -la /opt/homebrew/bin/brew
      register: brew_check
      ignore_errors: yes

    - name: Homebrew ìƒíƒœ ì¶œë ¥
      debug:
        msg: "Homebrew {{ 'exists' if brew_check.rc == 0 else 'not found' }}"

    - name: Homebrew ìˆ˜ë™ ì„¤ì¹˜ ì•ˆë‚´
      debug:
        msg: |
          âš ï¸  Homebrewê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!
          
          ê° ì„œë²„ì— SSHë¡œ ì ‘ì†í•´ì„œ ìˆ˜ë™ ì„¤ì¹˜í•˜ì„¸ìš”:
          ssh -i ~/.ssh/ansible_key {{ ansible_user }}@{{ ansible_host }}
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          
          ì„¤ì¹˜ í›„ ì´ í”Œë ˆì´ë¶ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.
      when: brew_check.rc != 0

    - name: .zshrc íŒŒì¼ ìƒì„± ë° PATH ì„¤ì •
      blockinfile:
        path: "{{ ansible_env.HOME }}/.zshrc"
        marker: "# {mark} HOMEBREW SETUP"
        block: |
          # Homebrew PATH ì„¤ì •
          eval "$(/opt/homebrew/bin/brew shellenv)"
          
          # Docker CLI PATH ì„¤ì • (Docker Desktop)
          export PATH="/Applications/Docker.app/Contents/Resources/bin:$PATH"
        create: yes

    - name: ê³µí†µ ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      homebrew:
        name: "{{ item }}"
        state: present
      loop: "{{ common_packages }}"  # group_vars/all.ymlì—ì„œ ë¡œë“œ
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"

    - name: ê³µí†µ ë””ë ‰í† ë¦¬ ìƒì„±
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop: "{{ common_directories }}"  # group_vars/all.ymlì—ì„œ ë¡œë“œ

- name: iOS CI ì„œë²„ ì „ìš© íŒ¨í‚¤ì§€ ì„¤ì¹˜
  hosts: ci_servers
  # vars ì„¹ì…˜ ì œê±° - group_vars/ci_servers.ymlì—ì„œ ë¡œë“œë¨
      
  tasks:
    - name: iOS ê°œë°œ ë„êµ¬ ì„¤ì¹˜
      homebrew:
        name: "{{ item }}"
        state: present
      loop: "{{ ios_packages }}"  # group_vars/ci_servers.ymlì—ì„œ ë¡œë“œ
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"

    - name: iOS í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop: "{{ ios_directories }}"  # group_vars/ci_servers.ymlì—ì„œ ë¡œë“œ

- name: Android ì„œë²„ ì „ìš© íŒ¨í‚¤ì§€ ì„¤ì¹˜
  hosts: docker_servers
  # vars ì„¹ì…˜ ì œê±° - group_vars/docker_servers.ymlì—ì„œ ë¡œë“œë¨
      
  tasks:
    - name: Android ê°œë°œ ë„êµ¬ ì„¤ì¹˜
      homebrew:
        name: "{{ item }}"
        state: present
      loop: "{{ android_packages }}"  # group_vars/docker_servers.ymlì—ì„œ ë¡œë“œ
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"

    - name: Docker Desktop ì„¤ì¹˜ í™•ì¸
      stat:
        path: "/Applications/Docker.app"
      register: docker_app_exists

    - name: Docker Desktop ì„¤ì¹˜ (í•„ìš”í•œ ê²½ìš°ë§Œ)
      homebrew_cask:
        name: docker
        state: present
      when: not docker_app_exists.stat.exists
      register: docker_install
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"

    - name: Android í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop: "{{ android_directories }}"  # group_vars/docker_servers.ymlì—ì„œ ë¡œë“œ

    - name: Docker Desktop ì‹œì‘ ì•ˆë‚´
      debug:
        msg: |
          {% if docker_app_exists.stat.exists %}
          âœ… Docker Desktopì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤!
          {% elif docker_install is defined and docker_install.changed %}
          âœ… Docker Desktop ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
          {% endif %}
          
          ğŸ³ ë‹¤ìŒ ë‹¨ê³„:
          1. Applications í´ë”ì—ì„œ Docker ì•±ì„ ì‹¤í–‰í•˜ì„¸ìš”
          2. Docker Desktopì´ ì™„ì „íˆ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸° (2-3ë¶„)
          3. ìƒˆ í„°ë¯¸ë„ì—ì„œ 'docker ps' ëª…ë ¹ì–´ í…ŒìŠ¤íŠ¸
          
          âœ… Docker ì¤€ë¹„ í™•ì¸ ëª…ë ¹ì–´:
          ansible {{ inventory_hostname }} -a "docker ps"

- name: Oh My Zsh ë° agnoster í…Œë§ˆ ì„¤ì •
  hosts: all_macs
  tasks:
    - name: Oh My Zsh ì„¤ì¹˜ í™•ì¸
      stat:
        path: "{{ ansible_env.HOME }}/.oh-my-zsh"
      register: omz_exists

    - name: Oh My Zsh ì„¤ì¹˜ (í•„ìš”ì‹œ)
      shell: |
        sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
      when: not omz_exists.stat.exists

    - name: Oh My Zsh í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
      git:
        repo: "{{ omz_plugins[item].repo }}"
        dest: "{{ ansible_env.HOME }}/.oh-my-zsh/{{ omz_plugins[item].dest }}"
        clone: yes
        update: yes
      loop:
        - zsh-autosuggestions
        - zsh-syntax-highlighting

    - name: agnoster í…Œë§ˆ ë° í†µí•© ì„¤ì •
      copy:
        content: |
          # Oh My Zsh ì„¤ì •
          export ZSH="$HOME/.oh-my-zsh"
          ZSH_THEME="agnoster"
          
          # í”ŒëŸ¬ê·¸ì¸ ì„¤ì •
          plugins=(git zsh-autosuggestions zsh-syntax-highlighting)
          
          # Oh My Zsh ë¡œë“œ
          source $ZSH/oh-my-zsh.sh
          
          # Homebrew PATH ì„¤ì •
          eval "$(/opt/homebrew/bin/brew shellenv)"
          
          # Docker CLI PATH ì„¤ì • (Docker Desktop)
          export PATH="/Applications/Docker.app/Contents/Resources/bin:$PATH"
          
          # agnoster í…Œë§ˆ ì„¤ì •
          DEFAULT_USER="{{ ansible_user }}"
          
          # ìœ ìš©í•œ aliases
          alias ll='ls -la'
          alias la='ls -A'
          alias ..='cd ..'
          alias ...='cd ../..'
          alias brewup='brew update && brew upgrade && brew cleanup'
          alias jenkins-start='brew services start jenkins-lts'
          alias jenkins-stop='brew services stop jenkins-lts'
          alias jenkins-status='brew services list | grep jenkins'
          
          # Docker ê´€ë ¨ aliases
          alias dps='docker ps'
          alias dpa='docker ps -a'
          alias di='docker images'
          alias dc='docker compose'
          alias dcup='docker compose up -d'
          alias dcdown='docker compose down'
          alias dclogs='docker compose logs -f'
        dest: "{{ ansible_env.HOME }}/.zshrc"
        mode: '0644'
        
- name: ì„¤ì¹˜ ì™„ë£Œ í™•ì¸
  hosts: all_macs
  tasks:
    - name: ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ í™•ì¸
      shell: /opt/homebrew/bin/brew list --formula
      register: installed_packages
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"

    - name: ì„¤ì¹˜ëœ Cask ì• í”Œë¦¬ì¼€ì´ì…˜ í™•ì¸ (Docker ì„œë²„)
      shell: /opt/homebrew/bin/brew list --cask
      register: installed_casks
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      when: inventory_hostname in groups['docker_servers']

    - name: ì„¤ì¹˜ ì™„ë£Œ ë©”ì‹œì§€
      debug:
        msg: |
          =================================
          {{ inventory_hostname }} ì„¤ì¹˜ ì™„ë£Œ!
          ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ìˆ˜: {{ installed_packages.stdout_lines | length }}
          {% if inventory_hostname in groups['docker_servers'] and installed_casks is defined %}
          ì„¤ì¹˜ëœ Cask ì•±: {{ installed_casks.stdout_lines | length }}ê°œ
          {% endif %}
          agnoster í…Œë§ˆ ì ìš©ë¨!
          {% if inventory_hostname in groups['docker_servers'] %}
          
          ğŸ³ Docker Desktop ì„¤ì¹˜ë¨!
          ë‹¤ìŒ ë‹¨ê³„: Docker Desktop ì•±ì„ ì‹¤í–‰í•˜ì„¸ìš”
          {% endif %}
          =================================