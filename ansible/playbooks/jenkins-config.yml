---
- name: Jenkins ì›ë³¸ ì„¤ì • íŒŒì¼ ìˆ˜ì •
  hosts: all_macs
  gather_facts: yes
  vars:
    jenkins_port: "8081"

  tasks:
    - name: ansible ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
      file:
        path: "{{ ansible_env.HOME }}/ansible"
        state: directory
        mode: '0755'

    - name: Homebrew prefix í™•ì¸
      shell: /opt/homebrew/bin/brew --prefix
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      register: homebrew_prefix

    - name: Jenkins ì„¤ì¹˜ ê²½ë¡œ ë° ë²„ì „ í™•ì¸
      shell: |
        echo "=== Jenkins ì„¤ì¹˜ ì •ë³´ ==="
        /opt/homebrew/bin/brew list --versions jenkins-lts
        echo ""
        echo "=== Cellar ë””ë ‰í† ë¦¬ í™•ì¸ ==="
        ls -la {{ homebrew_prefix.stdout }}/Cellar/jenkins-lts/
        echo ""
        echo "=== í˜„ì¬ ì‹¬ë§í¬ ==="
        ls -la {{ homebrew_prefix.stdout }}/opt/jenkins-lts
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      register: jenkins_info

    - name: Jenkins ë²„ì „ ì¶”ì¶œ
      shell: /opt/homebrew/bin/brew list --versions jenkins-lts | awk '{print $2}'
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      register: jenkins_version

    - name: ì›ë³¸ plist íŒŒì¼ ê²½ë¡œ ì„¤ì •
      set_fact:
        jenkins_cellar_path: "{{ homebrew_prefix.stdout }}/Cellar/jenkins-lts/{{ jenkins_version.stdout }}"
        original_plist_path: "{{ homebrew_prefix.stdout }}/Cellar/jenkins-lts/{{ jenkins_version.stdout }}/homebrew.mxcl.jenkins-lts.plist"

    - name: ì›ë³¸ plist íŒŒì¼ í™•ì¸
      shell: |
        echo "=== ì›ë³¸ plist íŒŒì¼ ìœ„ì¹˜ ==="
        ls -la {{ original_plist_path }}
        echo ""
        echo "=== ì›ë³¸ plist ë‚´ìš© ==="
        cat {{ original_plist_path }}
      register: original_plist_content

    - name: Java ê²½ë¡œ ìë™ ê°ì§€
      shell: |
        if [ -f "{{ homebrew_prefix.stdout }}/opt/openjdk@21/bin/java" ]; then
          echo "{{ homebrew_prefix.stdout }}/opt/openjdk@21/bin/java"
        elif [ -f "{{ homebrew_prefix.stdout }}/opt/openjdk@17/bin/java" ]; then
          echo "{{ homebrew_prefix.stdout }}/opt/openjdk@17/bin/java"
        elif [ -f "{{ homebrew_prefix.stdout }}/opt/openjdk@11/bin/java" ]; then
          echo "{{ homebrew_prefix.stdout }}/opt/openjdk@11/bin/java"
        elif [ -f "{{ homebrew_prefix.stdout }}/opt/openjdk/bin/java" ]; then
          echo "{{ homebrew_prefix.stdout }}/opt/openjdk/bin/java"
        else
          which java || echo "/usr/bin/java"
        fi
      register: detected_java_path

    - name: Jenkins ì„œë¹„ìŠ¤ ì¤‘ì§€
      shell: /opt/homebrew/bin/brew services stop jenkins-lts
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      ignore_errors: yes

    - name: ì›ë³¸ plist íŒŒì¼ ë°±ì—…
      copy:
        src: "{{ original_plist_path }}"
        dest: "{{ ansible_env.HOME }}/ansible/original-jenkins-plist-backup-{{ jenkins_version.stdout }}-{{ ansible_date_time.date }}.plist"
        mode: '0644'
        remote_src: yes

    - name: ì›ë³¸ plist íŒŒì¼ ìˆ˜ì •
      copy:
        content: |
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
                  <key>Label</key>
                  <string>homebrew.mxcl.jenkins-lts</string>
                  <key>LimitLoadToSessionType</key>
                  <array>
                          <string>Aqua</string>
                          <string>Background</string>
                          <string>LoginWindow</string>
                          <string>StandardIO</string>
                          <string>System</string>
                  </array>
                  <key>ProgramArguments</key>
                  <array>
                          <string>{{ detected_java_path.stdout }}</string>
                          <string>-Dmail.smtp.starttls.enable=true</string>
                          <string>-Dhudson.plugins.git.GitSCM.ALLOW_LOCAL_CHECKOUT=true</string>
                          <string>-jar</string>
                          <string>{{ homebrew_prefix.stdout }}/opt/jenkins-lts/libexec/jenkins.war</string>
                          <string>--httpListenAddress={{ ansible_host }}</string>
                          <string>--httpPort={{ jenkins_port }}</string>
                  </array>
                  <key>RunAtLoad</key>
                  <true/>
          </dict>
          </plist>
        dest: "{{ original_plist_path }}"
        mode: '0644'
        backup: yes

    - name: LaunchAgentsì˜ ê¸°ì¡´ plist ì‚­ì œ (ìƒˆë¡œ ë³µì‚¬ë˜ë„ë¡)
      shell: rm -f ~/Library/LaunchAgents/homebrew.mxcl.jenkins-lts.plist

    - name: Jenkins ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      shell: |
        /opt/homebrew/bin/brew services start jenkins-lts
        sleep 10
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"

    - name: ìˆ˜ì • ê²°ê³¼ í™•ì¸
      shell: |
        echo "=== ìˆ˜ì •ëœ ì›ë³¸ plist ==="
        cat {{ original_plist_path }} | grep -A 2 "httpListenAddress\|httpPort"
        echo ""
        echo "=== LaunchAgents plist ==="
        cat ~/Library/LaunchAgents/homebrew.mxcl.jenkins-lts.plist | grep -A 2 "httpListenAddress\|httpPort"
        echo ""
        echo "=== Jenkins í”„ë¡œì„¸ìŠ¤ ==="
        sleep 5
        ps aux | grep jenkins | grep java || echo "Jenkins í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
        echo ""
        echo "=== í¬íŠ¸ í™•ì¸ ==="
        lsof -i :{{ jenkins_port }} || echo "í¬íŠ¸ {{ jenkins_port }} ì‚¬ìš© ì—†ìŒ"
      register: verification_result

    - name: ê²°ê³¼ ë¦¬í¬íŠ¸
      debug:
        msg: |
          ==========================================
          {{ inventory_hostname }} ì›ë³¸ Jenkins ì„¤ì • ìˆ˜ì • ì™„ë£Œ! âœ…
          ==========================================
          
          ğŸ“ ìˆ˜ì •ëœ ì›ë³¸ íŒŒì¼:
          {{ original_plist_path }}
          
          ğŸ”§ ì ìš©ëœ ì„¤ì •:
          - IP: {{ ansible_host }}
          - Port: {{ jenkins_port }}
          - Java: {{ detected_java_path.stdout }}
          - Git Local Checkout: í™œì„±í™”
          
          ğŸ“‹ Jenkins ì •ë³´:
          {{ jenkins_info.stdout }}
          
          ğŸ” í™•ì¸ ê²°ê³¼:
          {{ verification_result.stdout }}
          
          ğŸŒ ì ‘ì† URL:
          http://{{ ansible_host }}:{{ jenkins_port }}
          
          ğŸ“„ ë°±ì—… íŒŒì¼:
          ~/ansible/original-jenkins-plist-backup-{{ jenkins_version.stdout }}-{{ ansible_date_time.date }}.plist
          
          âš ï¸  ì£¼ì˜ì‚¬í•­:
          brew upgrade jenkins-lts ì‹œ ì›ë³¸ íŒŒì¼ì´ ìƒˆ ë²„ì „ìœ¼ë¡œ êµì²´ë©ë‹ˆë‹¤.
          ì—…ê·¸ë ˆì´ë“œ í›„ ì´ í”Œë ˆì´ë¶ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.
          ==========================================

    - name: ì„¤ì • ë¡œê·¸ ì €ì¥
      copy:
        content: |
          ==========================================
          {{ inventory_hostname }} ì›ë³¸ Jenkins ì„¤ì • ë³€ê²½ ë¡œê·¸
          ì‹¤í–‰ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ==========================================
          
          ğŸ“¦ Jenkins ë²„ì „: {{ jenkins_version.stdout }}
          ğŸ“ ì›ë³¸ íŒŒì¼ ê²½ë¡œ: {{ original_plist_path }}
          
          ğŸ”§ ì ìš©ëœ ì„¤ì •:
          - IP ì£¼ì†Œ: {{ ansible_host }}
          - í¬íŠ¸: {{ jenkins_port }}
          - Java ê²½ë¡œ: {{ detected_java_path.stdout }}
          - Git Local Checkout: í™œì„±í™”
          
          ğŸ“‹ ì›ë³¸ ë‚´ìš© (ìˆ˜ì • ì „):
          {{ original_plist_content.stdout }}
          
          ğŸ” ìˆ˜ì • í›„ í™•ì¸:
          {{ verification_result.stdout }}
          
          ğŸ“„ ë°±ì—… íŒŒì¼: ~/ansible/original-jenkins-plist-backup-{{ jenkins_version.stdout }}-{{ ansible_date_time.date }}.plist
          
          ==========================================
          ì™„ë£Œ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ==========================================
        dest: "{{ ansible_env.HOME }}/ansible/jenkins-source-config-{{ ansible_date_time.date }}-{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}.txt"
        mode: '0644'