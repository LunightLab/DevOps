---
- name: ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤ ê´€ë¦¬
  hosts: all_macs
  gather_facts: yes
  vars_prompt:
    - name: "action"
      prompt: "ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš” (start/stop/restart/status)"
      default: "status"
      private: no

  tasks:
    - name: ansible ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
      file:
        path: "{{ ansible_env.HOME }}/ansible"
        state: directory
        mode: '0755'

    - name: CI ì„œë²„ ì„œë¹„ìŠ¤ ê´€ë¦¬
      block:
        - name: Jenkins ì„œë¹„ìŠ¤ ê´€ë¦¬
          shell: /opt/homebrew/bin/brew services {{ action }} jenkins-lts
          environment:
            PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
          register: jenkins_result
          ignore_errors: yes
          when: action in ['start', 'stop', 'restart']

        - name: Grafana ì„œë¹„ìŠ¤ ê´€ë¦¬
          shell: /opt/homebrew/bin/brew services {{ action }} grafana
          environment:
            PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
          register: grafana_result
          ignore_errors: yes
          when: action in ['start', 'stop', 'restart']

        - name: Prometheus ì„œë¹„ìŠ¤ ê´€ë¦¬
          shell: /opt/homebrew/bin/brew services {{ action }} prometheus
          environment:
            PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
          register: prometheus_result
          ignore_errors: yes
          when: action in ['start', 'stop', 'restart']

      when: inventory_hostname in groups['ci_servers']

    - name: Docker ì„œë²„ ì„œë¹„ìŠ¤ ê´€ë¦¬
      block:
        - name: Jenkins ì„œë¹„ìŠ¤ ê´€ë¦¬ (Docker ì„œë²„)
          shell: /opt/homebrew/bin/brew services {{ action }} jenkins-lts
          environment:
            PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
          register: jenkins_docker_result
          ignore_errors: yes
          when: action in ['start', 'stop', 'restart']

        - name: Docker ìƒíƒœ í™•ì¸ (ì¬ì‹œì‘í•˜ì§€ ì•ŠìŒ)
          shell: |
            if command -v docker >/dev/null 2>&1; then
              echo "=== Docker ìƒíƒœ ==="
              docker version --format "Docker: {{.Server.Version}}" 2>/dev/null || echo "Docker ì„œë²„ ì—°ê²° ì‹¤íŒ¨"
              echo ""
              echo "=== ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ==="
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "ì»¨í…Œì´ë„ˆ ì •ë³´ í™•ì¸ ì‹¤íŒ¨"
              echo ""
              echo "âš ï¸  DockerëŠ” ì•ˆì „ì„ ìœ„í•´ ìë™ ì¬ì‹œì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            else
              echo "Docker not installed"
            fi
          register: docker_status
          when: action == 'status'

      when: inventory_hostname in groups['docker_servers']

    - name: ëª¨ë“  ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
      shell: /opt/homebrew/bin/brew services list
      environment:
        PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
      register: all_services_status

    - name: í¬íŠ¸ ì‚¬ìš© í˜„í™© í™•ì¸
      shell: |
        echo "=== ì£¼ìš” í¬íŠ¸ ì‚¬ìš© í˜„í™© ==="
        lsof -i :3000 2>/dev/null | head -2 || echo "í¬íŠ¸ 3000: ì‚¬ìš© ì•ˆí•¨"
        lsof -i :8080 2>/dev/null | head -2 || echo "í¬íŠ¸ 8080: ì‚¬ìš© ì•ˆí•¨"
        lsof -i :9090 2>/dev/null | head -2 || echo "í¬íŠ¸ 9090: ì‚¬ìš© ì•ˆí•¨"
      register: port_status

    - name: ì„œë¹„ìŠ¤ ìƒíƒœ ìš”ì•½ ë¦¬í¬íŠ¸
      debug:
        msg: |
          ============================================
          {{ inventory_hostname }} ì„œë¹„ìŠ¤ ìƒíƒœ âœ…
          ============================================
          
          {% set running_services = [] %}
          {% for line in all_services_status.stdout_lines %}
          {% if 'started' in line %}
          {% set _ = running_services.append(line.split()[0]) %}
          {% endif %}
          {% endfor %}
          
          ğŸŸ¢ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤: {{ running_services | join(', ') }}
          
          ğŸŒ ì ‘ì† URL:
          {% if 'jenkins-lts' in running_services %}
          ğŸ“Š Jenkins: http://{{ inventory_hostname }}:8080
          {% endif %}
          {% if 'grafana' in running_services %}
          ğŸ“ˆ Grafana: http://{{ inventory_hostname }}:3000
          {% endif %}
          {% if 'prometheus' in running_services %}
          ğŸ” Prometheus: http://{{ inventory_hostname }}:9090
          {% endif %}
          
          {% if action in ['start', 'stop', 'restart'] %}
          ğŸ”„ ì‘ì—… ê²°ê³¼: {{ action.upper() }} ì™„ë£Œ
          {% endif %}
          ============================================

    - name: ìƒì„¸ ìƒíƒœ ë¦¬í¬íŠ¸ (íŒŒì¼ë¡œ ì €ì¥)
      debug:
        msg: |
          ğŸ“‹ ìƒì„¸ ì •ë³´ëŠ” ë¡œê·¸ íŒŒì¼ì— ì €ì¥ë©ë‹ˆë‹¤:
          ~/ansible/service-{{ action }}-{{ ansible_date_time.date }}-{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}.txt

    - name: ìƒì„¸ ì„œë¹„ìŠ¤ ë¡œê·¸ ì €ì¥
      copy:
        content: |
          ==========================================
          {{ inventory_hostname }} ì„œë¹„ìŠ¤ ê´€ë¦¬ ìƒì„¸ ë¡œê·¸
          ì‹¤í–‰ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ì‘ì—…: {{ action }}
          ==========================================
          
          ğŸ“‹ ì „ì²´ Homebrew ì„œë¹„ìŠ¤:
          {{ all_services_status.stdout }}
          
          ğŸ”Œ í¬íŠ¸ ì‚¬ìš© í˜„í™©:
          {{ port_status.stdout }}
          
          {% if inventory_hostname in groups['docker_servers'] and docker_status is defined and docker_status.stdout is defined %}
          ğŸ³ Docker ì»¨í…Œì´ë„ˆ:
          {{ docker_status.stdout }}
          {% endif %}
          
          {% if action in ['start', 'stop', 'restart'] %}
          ğŸ“ ì‘ì—… ê²°ê³¼:
          {% if inventory_hostname in groups['ci_servers'] %}
          {% if jenkins_result is defined %}
          - Jenkins: {{ 'SUCCESS' if jenkins_result.rc == 0 else 'FAILED' }}
          {% endif %}
          {% if grafana_result is defined %}
          - Grafana: {{ 'SUCCESS' if grafana_result.rc == 0 else 'FAILED' }}
          {% endif %}
          {% if prometheus_result is defined %}
          - Prometheus: {{ 'SUCCESS' if prometheus_result.rc == 0 else 'FAILED' }}
          {% endif %}
          {% endif %}
          {% if inventory_hostname in groups['docker_servers'] and jenkins_docker_result is defined %}
          - Jenkins (Docker): {{ 'SUCCESS' if jenkins_docker_result.rc == 0 else 'FAILED' }}
          {% endif %}
          {% endif %}
          
          ==========================================
          ì™„ë£Œ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ==========================================
        dest: "{{ ansible_env.HOME }}/ansible/service-{{ action }}-{{ ansible_date_time.date }}-{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}.txt"
        mode: '0644'

- name: ì—…ë°ì´íŠ¸ í›„ ìë™ ì¬ì‹œì‘ (ì˜µì…˜)
  hosts: all_macs
  tasks:
    - name: ì—…ë°ì´íŠ¸ í›„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ í™•ì¸
      debug:
        msg: |
          ğŸ’¡ ì—…ë°ì´íŠ¸ í›„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ì´ í•„ìš”í•œ ê²½ìš°:
          
          ìë™ ì¬ì‹œì‘ (Jenkins, Grafana, Prometheusë§Œ):
          ansible-playbook playbooks/system-restart.yml -e "action=restart"
          
          ê°œë³„ ì¬ì‹œì‘:
          ansible {{ inventory_hostname }} -a "brew services restart jenkins-lts"
          ansible {{ inventory_hostname }} -a "brew services restart grafana"
          ansible {{ inventory_hostname }} -a "brew services restart prometheus"
          
          âš ï¸  DockerëŠ” ì•ˆì „ì„ ìœ„í•´ ìˆ˜ë™ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”:
          - Docker Desktop ì¬ì‹œì‘ (GUIì—ì„œ)
          - ê°œë³„ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘: docker restart <container_name>