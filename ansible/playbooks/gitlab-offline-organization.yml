---
# Docker GitLab ë‹¤ìš´íƒ€ì„ ì •ë¦¬ í”Œë ˆì´ë¶ (ì•ˆì „í•˜ê³  ì² ì €í•œ ì •ë¦¬)
# ì‚¬ìš©ë²•: ansible-playbook -i inventory docker-gitlab-downtime-cleanup.yml

- name: Docker GitLab ë‹¤ìš´íƒ€ì„ ì •ë¦¬ (ì•ˆì „í•˜ê³  ì² ì €í•œ ìµœì í™”)
  hosts: docker_servers
  gather_facts: yes
  vars:
    gitlab_container: "gitlab"
    docker_compose_dir: "/opt/gitlab-docker"
    # ë‹¤ìš´íƒ€ì„ ì„¤ì •
    safe_downtime_mode: true
    estimated_downtime_minutes: 7  # ì˜ˆìƒ ë‹¤ìš´íƒ€ì„
    
  tasks:
    - name: ansible ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
      file:
        path: "{{ ansible_env.HOME }}/ansible"
        state: directory
        mode: '0755'

    - name: Docker ëª…ë ¹ì–´ ê²½ë¡œ í™•ì¸ (macOS í˜¸í™˜)
      shell: |
        if command -v /opt/homebrew/bin/docker >/dev/null 2>&1; then
          echo "homebrew_docker"
          /opt/homebrew/bin/docker ps
        elif command -v /Applications/Docker.app/Contents/Resources/bin/docker >/dev/null 2>&1; then
          echo "desktop_docker"
          /Applications/Docker.app/Contents/Resources/bin/docker ps
        elif command -v docker >/dev/null 2>&1; then
          echo "system_docker"
          docker ps
        else
          echo "no_docker"
          exit 1
        fi
      register: docker_path_check
      ignore_errors: yes
      failed_when: false

    - name: Docker ëª…ë ¹ì–´ ê²½ë¡œ ì„¤ì •
      set_fact:
        docker_cmd: >-
          {%- if docker_path_check.stdout_lines[0] == 'homebrew_docker' -%}
          /opt/homebrew/bin/docker
          {%- elif docker_path_check.stdout_lines[0] == 'desktop_docker' -%}
          /Applications/Docker.app/Contents/Resources/bin/docker
          {%- elif docker_path_check.stdout_lines[0] == 'system_docker' -%}
          docker
          {%- else -%}
          docker
          {%- endif -%}

    - name: Docker ì‹¤í–‰ ìƒíƒœ í™•ì¸
      fail:
        msg: "Dockerê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Docker Desktopì„ ì‹œì‘í•´ì£¼ì„¸ìš”."
      when: docker_path_check.rc != 0

    - name: ë‹¤ìš´íƒ€ì„ ì •ë¦¬ ì‹œì‘ ì „ ì•ˆë‚´
      pause:
        prompt: |
          ğŸ›‘ GitLab ë‹¤ìš´íƒ€ì„ ì •ë¦¬ ì‘ì—… ğŸ›‘
          
          ì´ ì‘ì—…ì€ GitLabì„ ì•ˆì „í•˜ê²Œ ì •ì§€í•œ í›„ ì² ì €í•œ ì •ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤:
          
          ğŸ”§ ìˆ˜í–‰ ì‘ì—…:
          âœ… GitLab ì„œë¹„ìŠ¤ ì•ˆì „í•œ ì •ì§€
          âœ… GitLab ë‚´ë¶€ ë°ì´í„° ì² ì €í•œ ì •ë¦¬
          âœ… Docker ë¡œê·¸ íŒŒì¼ ì™„ì „ ì •ë¦¬
          âœ… Docker ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬ ìµœì í™”
          âœ… ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
          âœ… GitLab ì„œë¹„ìŠ¤ ê¹”ë”í•œ ì¬ì‹œì‘
          
          ğŸ”’ ë³´í˜¸ í•­ëª©:
          âŒ GitLab ì»¨í…Œì´ë„ˆ/ì´ë¯¸ì§€ ì‚­ì œ ì•ˆí•¨
          âŒ GitLab ë°ì´í„° ë³¼ë¥¨ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
          âŒ ë°±ì—… ì‘ì—… ì•ˆí•¨ (ë³„ë„ ê´€ë¦¬)
          
          â° ì˜ˆìƒ ë‹¤ìš´íƒ€ì„: {{ estimated_downtime_minutes }}ë¶„
          ğŸ’¾ ì˜ˆìƒ ìš©ëŸ‰ ì ˆì•½: 2-5GB
          
          í˜„ì¬ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          
          ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (yes/no)
      register: proceed_confirmation

    - name: í™•ì¸ ê²€ì¦
      fail:
        msg: "ì‚¬ìš©ìê°€ ì‘ì—…ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤."
      when: proceed_confirmation.user_input | lower != 'yes'

    - name: ë‹¤ìš´íƒ€ì„ ì‹œì‘ ê¸°ë¡
      set_fact:
        downtime_start: "{{ ansible_date_time.epoch }}"
        downtime_start_readable: "{{ ansible_date_time.iso8601 }}"

    - name: ì •ë¦¬ ì „ ìƒíƒœ ìˆ˜ì§‘
      block:
        - name: Docker ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸ (ì •ë¦¬ ì „)
          command: "{{ docker_cmd }} system df"
          register: docker_df_before
          
        - name: GitLab ë³¼ë¥¨ ìƒì„¸ ë¶„ì„
          shell: |
            echo "=== GitLab Docker ë³¼ë¥¨ ìƒì„¸ ë¶„ì„ ==="
            
            # GitLab ë³¼ë¥¨ë“¤ì˜ ì‹¤ì œ í¬ê¸° í™•ì¸
            for volume in $({{ docker_cmd }} volume ls -q | grep gitlab); do
              volume_size=$({{ docker_cmd }} system df -v | grep "$volume" | awk '{print $3}' || echo "N/A")
              echo "ë³¼ë¥¨ $volume: $volume_size"
            done
            
            echo ""
            echo "=== GitLab ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ìš©ëŸ‰ ë¶„ì„ ==="
            {{ docker_cmd }} exec {{ gitlab_container }} df -h 2>/dev/null || echo "ì»¨í…Œì´ë„ˆ ì‘ë‹µ ì—†ìŒ"
            
            echo ""
            echo "=== GitLab ë°ì´í„° ë””ë ‰í† ë¦¬ TOP 10 ==="
            {{ docker_cmd }} exec {{ gitlab_container }} du -sh /var/opt/gitlab/* 2>/dev/null | sort -hr | head -10 || echo "ë¶„ì„ ë¶ˆê°€"
          register: gitlab_volume_analysis_before
          ignore_errors: yes

        - name: Docker ì‹œìŠ¤í…œ ìƒíƒœ ë¶„ì„
          shell: |
            echo "=== Docker ì‹œìŠ¤í…œ ë¶„ì„ (ì •ë¦¬ ì „) ==="
            echo "ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ: $({{ docker_cmd }} ps -q | wc -l)"
            echo "ì „ì²´ ì»¨í…Œì´ë„ˆ: $({{ docker_cmd }} ps -a -q | wc -l)"
            echo "ì´ë¯¸ì§€ ê°œìˆ˜: $({{ docker_cmd }} images -q | wc -l)"
            echo "ë³¼ë¥¨ ê°œìˆ˜: $({{ docker_cmd }} volume ls -q | wc -l)"
            echo "GitLab ë³¼ë¥¨: $({{ docker_cmd }} volume ls -q | grep gitlab | wc -l)"
            echo "Dangling ì´ë¯¸ì§€: $({{ docker_cmd }} images -f dangling=true -q | wc -l)"
            echo "ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ: $({{ docker_cmd }} ps -a -f status=exited -q | wc -l)"
            echo "ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨: $({{ docker_cmd }} volume ls -f dangling=true -q | wc -l)"
          register: docker_system_before

    - name: GitLab ì„œë¹„ìŠ¤ ì•ˆì „í•œ ì •ì§€
      block:
        - name: í˜„ì¬ GitLab ìƒíƒœ í™•ì¸
          shell: "{{ docker_cmd }} ps --filter name={{ gitlab_container }} --format 'table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}'"
          register: gitlab_status_before_stop
          
        - name: GitLab ì»¨í…Œì´ë„ˆ ì•ˆì „í•œ ì •ì§€ (ì»¨í…Œì´ë„ˆ ë³´ì¡´)
          shell: |
            echo "ğŸ›‘ GitLab ì»¨í…Œì´ë„ˆ ì•ˆì „í•œ ì •ì§€ ì¤‘..."
            
            # í˜„ì¬ ì»¨í…Œì´ë„ˆ ID ì €ì¥ (ë³µêµ¬ë¥¼ ìœ„í•´)
            gitlab_container_id=$({{ docker_cmd }} ps --filter name={{ gitlab_container }} -q)
            echo "GitLab ì»¨í…Œì´ë„ˆ ID: $gitlab_container_id"
            
            if [ -n "$gitlab_container_id" ]; then
              echo "GitLab ì»¨í…Œì´ë„ˆë¥¼ ì •ì§€í•©ë‹ˆë‹¤..."
              {{ docker_cmd }} stop {{ gitlab_container }}
              
              echo "â³ GitLab ì •ì§€ í™•ì¸ ì¤‘..."
              sleep 15
              
              # ì •ì§€ í›„ì—ë„ ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
              if {{ docker_cmd }} ps -a --filter name={{ gitlab_container }} -q | grep -q .; then
                echo "âœ… GitLab ì»¨í…Œì´ë„ˆ ì •ì§€ ì™„ë£Œ (ì»¨í…Œì´ë„ˆ ë³´ì¡´ë¨)"
              else
                echo "âŒ ê²½ê³ : GitLab ì»¨í…Œì´ë„ˆê°€ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤!"
                exit 1
              fi
            else
              echo "âš ï¸ GitLab ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi
            
            echo "âœ… GitLab ì•ˆì „í•œ ì •ì§€ ì™„ë£Œ"
          register: gitlab_safe_stop_result
          environment:
            PATH: "/opt/homebrew/bin:/Applications/Docker.app/Contents/Resources/bin:{{ ansible_env.PATH }}"
          
        - name: GitLab ì»¨í…Œì´ë„ˆ ì¡´ì¬ ë° ì •ì§€ ìƒíƒœ í™•ì¸
          shell: |
            echo "ğŸ” GitLab ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸..."
            
            # ì»¨í…Œì´ë„ˆ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            if {{ docker_cmd }} ps -a --filter name={{ gitlab_container }} -q | grep -q .; then
              container_status=$({{ docker_cmd }} ps -a --filter name={{ gitlab_container }} --format '{{ "{{" }}.Status{{ "}}" }}')
              echo "âœ… GitLab ì»¨í…Œì´ë„ˆ ì¡´ì¬: $container_status"
              
              # ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
              if {{ docker_cmd }} ps --filter name={{ gitlab_container }} -q | grep -q .; then
                echo "âŒ GitLabì´ ì•„ì§ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
                exit 1
              else
                echo "âœ… GitLabì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
              fi
            else
              echo "âŒ ì‹¬ê°í•œ ì˜¤ë¥˜: GitLab ì»¨í…Œì´ë„ˆê°€ ì™„ì „íˆ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤!"
              echo "ë³µêµ¬ê°€ í•„ìš”í•©ë‹ˆë‹¤."
              exit 1
            fi
          register: gitlab_container_check
          failed_when: gitlab_container_check.rc != 0

    - name: GitLab ë‚´ë¶€ ë°ì´í„° ì² ì €í•œ ì •ë¦¬ (ë‹¤ìš´íƒ€ì„ ì¤‘)
      block:
        - name: GitLab ë³¼ë¥¨ ì§ì ‘ ì •ë¦¬ (ì»¨í…Œì´ë„ˆ ì •ì§€ ìƒíƒœ)
          shell: |
            echo "ğŸ§¹ GitLab ë³¼ë¥¨ ì§ì ‘ ì •ë¦¬ ì‹œì‘..."
            
            # GitLab ë³¼ë¥¨ë“¤ì— ì§ì ‘ ì ‘ê·¼í•˜ì—¬ ì •ë¦¬
            for volume in $({{ docker_cmd }} volume ls -q | grep gitlab); do
              echo "ì •ë¦¬ ì¤‘: $volume"
              
              # ì„ì‹œ ì»¨í…Œì´ë„ˆë¡œ ë³¼ë¥¨ ë§ˆìš´íŠ¸í•˜ì—¬ ì •ë¦¬
              {{ docker_cmd }} run --rm -v ${volume}:/data alpine sh -c "
                echo '  - ì„ì‹œ íŒŒì¼ ì •ë¦¬...'
                find /data -name '*.tmp' -type f -delete 2>/dev/null || true
                find /data -name 'tmp' -type d -exec rm -rf {}/* \; 2>/dev/null || true
                
                echo '  - ë¡œê·¸ ì•„ì¹´ì´ë¸Œ ì •ë¦¬...'
                find /data -name '*.log.gz' -mtime +30 -delete 2>/dev/null || true
                find /data -name '*.log.*' -mtime +7 -delete 2>/dev/null || true
                
                echo '  - ìºì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬...'
                find /data -name 'cache' -type d -exec rm -rf {}/* \; 2>/dev/null || true
                find /data -name 'tmp' -type d -exec rm -rf {}/tmp/* \; 2>/dev/null || true
                
                echo '  - ì„¸ì…˜ íŒŒì¼ ì •ë¦¬...'
                find /data -name 'sessions' -type d -exec rm -rf {}/session* \; 2>/dev/null || true
                
                echo '  - ë°±ì—… íŒŒì¼ ì •ë¦¬ (7ì¼ ì´ìƒ)...'
                find /data -name '*.tar' -mtime +7 -delete 2>/dev/null || true
                find /data -name 'backup_*' -mtime +7 -delete 2>/dev/null || true
              " 2>/dev/null || echo "  - $volume ì •ë¦¬ ì¤‘ ì¼ë¶€ ì˜¤ë¥˜ (ì •ìƒ)"
            done
            
            echo "âœ… GitLab ë³¼ë¥¨ ì§ì ‘ ì •ë¦¬ ì™„ë£Œ"
          register: gitlab_volume_direct_cleanup

    - name: Docker ì‹œìŠ¤í…œ ì™„ì „ ì •ë¦¬ (ë‹¤ìš´íƒ€ì„ í™œìš©)
      block:
        - name: Docker ë¡œê·¸ íŒŒì¼ ì™„ì „ ì •ë¦¬
          shell: |
            echo "ğŸ“ Docker ë¡œê·¸ íŒŒì¼ ì™„ì „ ì •ë¦¬ ì‹œì‘..."
            
            total_cleaned_mb=0
            log_backup_dir="{{ ansible_env.HOME }}/docker-log-backups/$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$log_backup_dir"
            
            # ëª¨ë“  ì»¨í…Œì´ë„ˆ ë¡œê·¸ ì •ë¦¬ (GitLab ì •ì§€ ìƒíƒœì´ë¯€ë¡œ ì•ˆì „)
            for container in $({{ docker_cmd }} ps -a --format "{{ '{{' }}.Names{{ '}}' }}"); do
              log_path=$({{ docker_cmd }} inspect --format='{{ '{{' }}.LogPath{{ '}}' }}' $container 2>/dev/null)
              if [ -f "$log_path" ]; then
                log_size=$(stat -f%z "$log_path" 2>/dev/null || echo "0")
                log_size_mb=$((log_size / 1024 / 1024))
                
                if [ $log_size_mb -gt 10 ]; then  # 10MB ì´ìƒ ëª¨ë‘ ì •ë¦¬ (ë” ì ê·¹ì )
                  echo "ì •ë¦¬: $container (${log_size_mb}MB)"
                  
                  # ìµœê·¼ 100ì¤„ë§Œ ë°±ì—… (ìš©ëŸ‰ ìµœì†Œí™”)
                  tail -100 "$log_path" > "$log_backup_dir/${container}_last100.log" 2>/dev/null || true
                  
                  # ë¡œê·¸ íŒŒì¼ ì™„ì „ ì´ˆê¸°í™” (ë‹¤ìš´íƒ€ì„ì´ë¯€ë¡œ ì•ˆì „)
                  echo "" > "$log_path" 2>/dev/null || true
                  total_cleaned_mb=$((total_cleaned_mb + log_size_mb))
                else
                  echo "ìŠ¤í‚µ: $container (${log_size_mb}MB)"
                fi
              fi
            done
            
            echo "âœ… Docker ë¡œê·¸ ì™„ì „ ì •ë¦¬ ì™„ë£Œ (${total_cleaned_mb}MB ì ˆì•½)"
            echo "ë°±ì—… ìœ„ì¹˜: $log_backup_dir"
          register: docker_log_complete_cleanup

        - name: Docker ì‹œìŠ¤í…œ ì•ˆì „í•œ ì •ë¦¬ (ì»¨í…Œì´ë„ˆ ì‚­ì œ ì œì™¸)
          shell: |
            echo "ğŸ’¾ Docker ì‹œìŠ¤í…œ ì•ˆì „í•œ ì •ë¦¬ ì‹œì‘..."
            
            # âš ï¸ ì»¨í…Œì´ë„ˆ ì‚­ì œëŠ” í•˜ì§€ ì•ŠìŒ (ë„ˆë¬´ ìœ„í—˜)
            echo "âš ï¸ ì»¨í…Œì´ë„ˆ ì‚­ì œëŠ” ê±´ë„ˆëœ€ (ì•ˆì „ì„ ìœ„í•´)"
            
            # 1. Dangling ì´ë¯¸ì§€ë§Œ ì •ë¦¬ (ì•ˆì „í•¨)
            echo "1. Dangling ì´ë¯¸ì§€ ì •ë¦¬..."
            dangling_images=$({{ docker_cmd }} images -f dangling=true -q)
            if [ -n "$dangling_images" ]; then
              echo "$dangling_images" | xargs {{ docker_cmd }} rmi -f 2>/dev/null || true
              echo "âœ… Dangling ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ"
            else
              echo "ì •ë¦¬í•  Dangling ì´ë¯¸ì§€ ì—†ìŒ"
            fi
            
            # 2. Docker ë¹Œë“œ ìºì‹œ ì •ë¦¬ (ì•ˆì „í•¨)
            echo "2. Docker ë¹Œë“œ ìºì‹œ ì •ë¦¬..."
            {{ docker_cmd }} builder prune -a -f
            
            # 3. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„¤íŠ¸ì›Œí¬ ì •ë¦¬ (ì•ˆì „í•¨)
            echo "3. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„¤íŠ¸ì›Œí¬ ì •ë¦¬..."
            {{ docker_cmd }} network prune -f
            
            # 4. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì •ë¦¬ (GitLab ë³¼ë¥¨ ë³´í˜¸)
            echo "4. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì •ë¦¬ (GitLab ë³¼ë¥¨ ë³´í˜¸)..."
            gitlab_volumes=$({{ docker_cmd }} volume ls -q | grep gitlab | tr '\n' '|' | sed 's/|$//')
            if [ -n "$gitlab_volumes" ]; then
              dangling_volumes=$({{ docker_cmd }} volume ls -f dangling=true -q | grep -vE "$gitlab_volumes" || echo "")
            else
              dangling_volumes=$({{ docker_cmd }} volume ls -f dangling=true -q || echo "")
            fi
            
            if [ -n "$dangling_volumes" ]; then
              echo "ì •ë¦¬í•  ë³¼ë¥¨: $dangling_volumes"
              echo "$dangling_volumes" | xargs {{ docker_cmd }} volume rm 2>/dev/null || true
              echo "âœ… ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì •ë¦¬ ì™„ë£Œ"
            else
              echo "ì •ë¦¬í•  ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì—†ìŒ"
            fi
            
            echo "âœ… Docker ì‹œìŠ¤í…œ ì•ˆì „í•œ ì •ë¦¬ ì™„ë£Œ!"
            echo "âš ï¸ ì»¨í…Œì´ë„ˆì™€ ì´ë¯¸ì§€ëŠ” ë³´ì¡´ë˜ì—ˆìŠµë‹ˆë‹¤."
          register: docker_system_safe_cleanup

        - name: Docker ì‹œìŠ¤í…œ ì „ì²´ ì •ë¦¬ (ìµœì¢…)
          shell: |
            echo "ğŸ”§ Docker ì‹œìŠ¤í…œ ìµœì¢… ì •ë¦¬..."
            
            # Docker ì‹œìŠ¤í…œ ì „ì²´ ì •ë¦¬ (ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ëª¨ë“  ê²ƒ)
            {{ docker_cmd }} system prune -f
            
            echo "âœ… Docker ì‹œìŠ¤í…œ ìµœì¢… ì •ë¦¬ ì™„ë£Œ!"
          register: docker_final_cleanup

    - name: GitLab ì„œë¹„ìŠ¤ ê¹”ë”í•œ ì¬ì‹œì‘
      block:
        - name: GitLab ì»¨í…Œì´ë„ˆ ì•ˆì „í•œ ì¬ì‹œì‘
          shell: |
            echo "ğŸš€ GitLab ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì¤‘..."
            
            # ë¨¼ì € ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if {{ docker_cmd }} ps -a --filter name={{ gitlab_container }} -q | grep -q .; then
              echo "âœ… GitLab ì»¨í…Œì´ë„ˆ ë°œê²¬ë¨"
              
              # Docker ì§ì ‘ ì‹œì‘ (ë” ì•ˆì „)
              {{ docker_cmd }} start {{ gitlab_container }}
              
              echo "â³ GitLab ì‹œì‘ ëŒ€ê¸° ì¤‘..."
              sleep 30
              
              # ì‹œì‘ í™•ì¸
              if {{ docker_cmd }} ps --filter name={{ gitlab_container }} -q | grep -q .; then
                echo "âœ… GitLab ì»¨í…Œì´ë„ˆ ì‹œì‘ ì„±ê³µ"
              else
                echo "âš ï¸ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨, Docker Composeë¡œ ì¬ì‹œë„..."
                cd {{ docker_compose_dir }}
                {{ docker_cmd }} compose up -d gitlab
                sleep 30
              fi
            else
              echo "âŒ GitLab ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤. Docker Composeë¡œ ì¬ìƒì„±..."
              cd {{ docker_compose_dir }}
              {{ docker_cmd }} compose up -d gitlab
              sleep 60
            fi
            
            echo "âœ… GitLab ì¬ì‹œì‘ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ"
          register: gitlab_safe_restart_result
          environment:
            PATH: "/opt/homebrew/bin:/Applications/Docker.app/Contents/Resources/bin:{{ ansible_env.PATH }}"

        - name: GitLab ìµœì¢… ìƒíƒœ í™•ì¸ ë° ë³µêµ¬
          shell: |
            echo "ğŸ” GitLab ìµœì¢… ìƒíƒœ í™•ì¸..."
            
            # ì»¨í…Œì´ë„ˆ ì¡´ì¬ ë° ì‹¤í–‰ ìƒíƒœ í™•ì¸
            if {{ docker_cmd }} ps --filter name={{ gitlab_container }} -q | grep -q .; then
              container_status=$({{ docker_cmd }} ps --filter name={{ gitlab_container }} --format '{{ "{{" }}.Status{{ "}}" }}')
              echo "âœ… GitLab ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘: $container_status"
              
              # í—¬ìŠ¤ì²´í¬ ì‹œë„ (ë‹¨ì¶•ë²„ì „ - 1ë¶„ë§Œ)
              echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ ì¤‘..."
              for i in {1..6}; do
                if curl -f -s http://localhost/-/liveness >/dev/null 2>&1; then
                  echo "âœ… GitLab í—¬ìŠ¤ì²´í¬ ì„±ê³µ ($i/6 ì‹œë„)"
                  break
                elif curl -f -s http://localhost/-/readiness >/dev/null 2>&1; then
                  echo "âœ… GitLab ì¤€ë¹„ ìƒíƒœ í™•ì¸ ($i/6 ì‹œë„)"
                  break
                elif curl -f -s http://localhost/ | grep -i gitlab >/dev/null 2>&1; then
                  echo "âœ… GitLab ì›¹ ì„œë¹„ìŠ¤ ì‘ë‹µ ($i/6 ì‹œë„)"
                  break
                else
                  echo "â³ GitLab ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/6)"
                  sleep 10
                fi
              done
            else
              echo "âŒ GitLab ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
              echo "ìˆ˜ë™ ë³µêµ¬ê°€ í•„ìš”í•©ë‹ˆë‹¤: cd {{ docker_compose_dir }} && docker compose up -d"
              exit 1
            fi
            
            echo "GitLab ìƒíƒœ í™•ì¸ ì™„ë£Œ"
          register: gitlab_final_health_check
          ignore_errors: yes

    - name: ë‹¤ìš´íƒ€ì„ ì¢…ë£Œ ë° ê²°ê³¼ ìˆ˜ì§‘
      block:
        - name: ë‹¤ìš´íƒ€ì„ ì¢…ë£Œ ê¸°ë¡
          set_fact:
            downtime_end: "{{ ansible_date_time.epoch }}"
            downtime_end_readable: "{{ ansible_date_time.iso8601 }}"
            actual_downtime_minutes: "{{ ((ansible_date_time.epoch | int) - (downtime_start | int)) // 60 }}"

        - name: ì •ë¦¬ í›„ ìƒíƒœ í™•ì¸
          command: "{{ docker_cmd }} system df"
          register: docker_df_after
          
        - name: ì •ë¦¬ í›„ Docker ì‹œìŠ¤í…œ ìƒíƒœ
          shell: |
            echo "=== Docker ì‹œìŠ¤í…œ ë¶„ì„ (ì •ë¦¬ í›„) ==="
            echo "ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ: $({{ docker_cmd }} ps -q | wc -l)"
            echo "ì „ì²´ ì»¨í…Œì´ë„ˆ: $({{ docker_cmd }} ps -a -q | wc -l)"
            echo "ì´ë¯¸ì§€ ê°œìˆ˜: $({{ docker_cmd }} images -q | wc -l)"
            echo "ë³¼ë¥¨ ê°œìˆ˜: $({{ docker_cmd }} volume ls -q | wc -l)"
            echo "GitLab ë³¼ë¥¨: $({{ docker_cmd }} volume ls -q | grep gitlab | wc -l)"
            echo "Dangling ì´ë¯¸ì§€: $({{ docker_cmd }} images -f dangling=true -q | wc -l)"
            echo "ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ: $({{ docker_cmd }} ps -a -f status=exited -q | wc -l)"
            echo "ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨: $({{ docker_cmd }} volume ls -f dangling=true -q | wc -l)"
          register: docker_system_after

    - name: GitLab ë‹¤ìš´íƒ€ì„ ì •ë¦¬ ì™„ë£Œ ë¦¬í¬íŠ¸
      set_fact:
        downtime_cleanup_report: |
          ==========================================
          ğŸ›‘ GitLab ë‹¤ìš´íƒ€ì„ ì •ë¦¬ ì™„ë£Œ! âœ…
          ==========================================
          
          ğŸ–¥ï¸ ì„œë²„: {{ inventory_hostname }}
          â° ë‹¤ìš´íƒ€ì„ ì‹œì‘: {{ downtime_start_readable }}
          â° ë‹¤ìš´íƒ€ì„ ì¢…ë£Œ: {{ downtime_end_readable }}
          â±ï¸ ì‹¤ì œ ë‹¤ìš´íƒ€ì„: {{ actual_downtime_minutes }}ë¶„
          
          === ìš©ëŸ‰ ë³€í™” ë¹„êµ ===
          ğŸ“Š ì •ë¦¬ ì „:
          {{ docker_df_before.stdout }}
          
          ğŸ“Š ì •ë¦¬ í›„:
          {{ docker_df_after.stdout }}
          
          === Docker ì‹œìŠ¤í…œ ë³€í™” ===
          ì •ë¦¬ ì „: {{ docker_system_before.stdout }}
          
          ì •ë¦¬ í›„: {{ docker_system_after.stdout }}
          
          === ìˆ˜í–‰ëœ ë‹¤ìš´íƒ€ì„ ìµœì í™” ===
          âœ… GitLab ì„œë¹„ìŠ¤ ì•ˆì „í•œ ì •ì§€ ë° ì¬ì‹œì‘
          âœ… GitLab ë³¼ë¥¨ ì§ì ‘ ì ‘ê·¼ ì •ë¦¬
          âœ… Docker ë¡œê·¸ íŒŒì¼ ì™„ì „ ì •ë¦¬
          âœ… Docker ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬ ìµœì í™”
          âœ… Dangling ì´ë¯¸ì§€/ì»¨í…Œì´ë„ˆ ì™„ì „ ì •ë¦¬
          âœ… ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë¦¬ì†ŒìŠ¤ ì² ì €í•œ ì •ë¦¬
          
          === ë³´ì¡´ëœ í•­ëª© (ì™„ì „ ë³´í˜¸) ===
          ğŸ”’ GitLab ì»¨í…Œì´ë„ˆ ë° ì´ë¯¸ì§€
          ğŸ”’ ëª¨ë“  GitLab ë°ì´í„° ë³¼ë¥¨
          ğŸ”’ GitLab ì„¤ì • ë° ì¤‘ìš” ë¡œê·¸
          
          === GitLab ì„œë¹„ìŠ¤ ìƒíƒœ ===
          {{ gitlab_health_final.stdout if gitlab_health_final is defined else 'í™•ì¸ í•„ìš”' }}
          
          === ìƒì„¸ ì •ë¦¬ ê²°ê³¼ ===
          ë³¼ë¥¨ ì •ë¦¬: {{ gitlab_volume_direct_cleanup.stdout_lines | join(' ') if gitlab_volume_direct_cleanup is defined }}
          
          ë¡œê·¸ ì •ë¦¬: {{ docker_log_complete_cleanup.stdout_lines | select('match', '.*ì ˆì•½.*') | list | join(' ') if docker_log_complete_cleanup is defined }}
          
          === ë‹¤ìŒ ê¶Œì¥ ì‘ì—… ===
          ğŸ’¡ ì •ê¸°ì ì¸ ë‹¤ìš´íƒ€ì„ ì •ë¦¬: ì›” 1íšŒ ì‹¤í–‰ ê¶Œì¥
          ğŸ’¡ GitLab ì„œë¹„ìŠ¤ ìƒíƒœ ëª¨ë‹ˆí„°ë§
          ğŸ’¡ ìš©ëŸ‰ ì‚¬ìš©ëŸ‰ ì£¼ê¸°ì  í™•ì¸
          ğŸ’¡ ë°±ì—… ë³„ë„ ê´€ë¦¬ ìœ ì§€
          ==========================================

    - name: ê²°ê³¼ ë¦¬í¬íŠ¸ ì¶œë ¥
      debug:
        var: downtime_cleanup_report

    - name: ë‹¤ìš´íƒ€ì„ ì •ë¦¬ ë¡œê·¸ ì €ì¥
      copy:
        content: |
          GitLab ë‹¤ìš´íƒ€ì„ ì •ë¦¬ ë¡œê·¸
          ========================
          ì‹¤í–‰ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          ì„œë²„: {{ inventory_hostname }}
          Docker ê²½ë¡œ: {{ docker_cmd }}
          ì‘ì—… ìœ í˜•: ë‹¤ìš´íƒ€ì„ ì •ë¦¬ (ì•ˆì „í•˜ê³  ì² ì €í•œ ìµœì í™”)
          
          === ë‹¤ìš´íƒ€ì„ ì •ë³´ ===
          ì‹œì‘ ì‹œê°„: {{ downtime_start_readable }}
          ì¢…ë£Œ ì‹œê°„: {{ downtime_end_readable }}
          ì‹¤ì œ ë‹¤ìš´íƒ€ì„: {{ actual_downtime_minutes }}ë¶„
          ì˜ˆìƒ ë‹¤ìš´íƒ€ì„: {{ estimated_downtime_minutes }}ë¶„
          
          === ì •ë¦¬ ì „ ìƒíƒœ ===
          {{ docker_df_before.stdout }}
          
          ì‹œìŠ¤í…œ ìƒíƒœ (ì •ë¦¬ ì „):
          {{ docker_system_before.stdout }}
          
          === ì •ë¦¬ í›„ ìƒíƒœ ===
          {{ docker_df_after.stdout }}
          
          ì‹œìŠ¤í…œ ìƒíƒœ (ì •ë¦¬ í›„):
          {{ docker_system_after.stdout }}
          
          === ìƒì„¸ ì •ë¦¬ ì‘ì—… ===
          ë³¼ë¥¨ ì§ì ‘ ì •ë¦¬:
          {{ gitlab_volume_direct_cleanup.stdout if gitlab_volume_direct_cleanup is defined else 'ì‹¤í–‰ë˜ì§€ ì•ŠìŒ' }}
          
          ë¡œê·¸ ì™„ì „ ì •ë¦¬:
          {{ docker_log_complete_cleanup.stdout if docker_log_complete_cleanup is defined else 'ì‹¤í–‰ë˜ì§€ ì•ŠìŒ' }}
          
          ì‹œìŠ¤í…œ ìµœì í™”:
          {{ docker_system_optimization.stdout if docker_system_optimization is defined else 'ì‹¤í–‰ë˜ì§€ ì•ŠìŒ' }}
          
          === GitLab ì¬ì‹œì‘ ê²°ê³¼ ===
          {{ gitlab_restart_result.stdout if gitlab_restart_result is defined else 'í™•ì¸ í•„ìš”' }}
          
          === í—¬ìŠ¤ì²´í¬ ê²°ê³¼ ===
          {{ gitlab_health_final.stdout if gitlab_health_final is defined else 'í™•ì¸ í•„ìš”' }}
          
          === ì•ˆì „ ì •ì±… ===
          âœ… GitLab ì»¨í…Œì´ë„ˆ/ì´ë¯¸ì§€ ì™„ì „ ë³´í˜¸
          âœ… GitLab ë°ì´í„° ë³¼ë¥¨ ì™„ì „ ë³´í˜¸
          âœ… ì•ˆì „í•œ ì„œë¹„ìŠ¤ ì •ì§€/ì¬ì‹œì‘
          âœ… ë‹¤ìš´íƒ€ì„ ì¤‘ ì² ì €í•œ ì •ë¦¬
          âœ… ì„œë¹„ìŠ¤ ìƒíƒœ ì™„ì „ ë³µêµ¬ í™•ì¸
          
          === ê¶Œì¥ì‚¬í•­ ===
          - ë‹¤ìš´íƒ€ì„ ì •ë¦¬ëŠ” ì›” 1íšŒ ì‹¤í–‰ ê¶Œì¥
          - ìƒˆë²½ ì‹œê°„ëŒ€ (02:00-04:00) ì‹¤í–‰ ê¶Œì¥
          - ì •ë¦¬ ì „ ë°±ì—… ìƒíƒœ í™•ì¸ í•„ìˆ˜
          - ì •ë¦¬ í›„ ì„œë¹„ìŠ¤ ë™ì‘ í™•ì¸ í•„ìˆ˜
        dest: "{{ ansible_env.HOME }}/ansible/gitlab-downtime-cleanup-{{ ansible_date_time.date }}.log"
        mode: '0644'